"use strict";function round(a,b){if(a=parseFloat(a),isNaN(a))return a;b||(b=0);var c=Math.pow(10,b);return Math.floor(a*c+(a*c*10%10>=5?1:0))/c}var resizeCanvasFont=function(){var a=$(window).height()-40,b=$(window).width()-80,c=a/3,d=b/5,e=Math.min(Math.max(5,Math.min(c,d)/20),15);$("html").css("font-size",e+"px"),console.log("resizeCanvasFont size=",e)};$(document).ready(function(){$(window).resize(resizeCanvasFont),resizeCanvasFont(),window.navigator.standalone});var FirstRevenueApp=angular.module("FirstRevenueApp",["ngResource","bootstrap","$strap.directives","firebase"]).config(["$routeProvider",function(a){a.when("/impress/:modelId",{templateUrl:"views/impress/Impress.html",controller:"ImpressController"}).when("/",{templateUrl:"views/impress/Impress.html",controller:"ImpressController"}).otherwise({redirectTo:"/"})}]).run(["$route",function(a){a.reload()}]);FirstRevenueApp.controller("AdminController",["$scope",function(a){var b="AdminController";console.log(b,"launched"),angular.extend(a,{admin:a.me.sync.admin,getOnlineUsers:function(){},getAdminUserIds:function(){return[]},getISODate:function(a){return new Date(Math.abs(a)).toISOString()}}),a.layout.setGuideWidth(),a.admin.enabled=!0,a.$on("$destroy",function(){a.admin.enabled=!1}),a.layout.setView("summary"),a.menu.setTitle("Administer "+a.appName)}]),FirstRevenueApp.controller("AdminRepoController",["$scope",function(a){a.orgRepo=a.repo.repo}]),FirstRevenueApp.controller("AngularController",["$scope",function(a){angular.extend(a,{q:FirstRevenueApp._invokeQueue,objType:function(a){return typeof a},testValue:function(a){return"value"===a}})}]),FirstRevenueApp.controller("CanvasController",["$scope","$route","$location","_","Modal","Zoom","Rainbow",function(a,b,c,d,e,f,g){var h="CanvasController";console.log(h,"route invoked $route=",b);var i=b.current.params.modelId,j={KP:{iconId:106,initials:"KP",name:"Key Partnerships"},KA:{iconId:51,initials:"KA",name:"Key Activities"},KR:{iconId:82,initials:"KR",name:"Key Resources"},VP:{iconId:89,initials:"VP",name:"Value Propositions"},CR:{iconId:83,initials:"CR",name:"Customer Relationships"},CH:{iconId:261,initials:"CH",name:"Channels"},CS:{iconId:175,initials:"CS",name:"Customer Segments"},CX:{iconId:165,initials:"C$",name:"Cost Structure"},RX:{iconId:200,initials:"R$",name:"Revenue Streams"}},k=[!0,"edit","full"],l=["full"];angular.extend(a,{modal:e,zoom:f,rainbow:g,blocks:null,stickers:null,getBlocks:function(){return j},getStickers:function(b){var c={},d=a.canvas.modelId,e=a.me.sync.models[d];return e&&e.stickers&&angular.forEach(a.me.sync.models[d].stickers,function(a,d){a.block===b&&(c[d]=a)}),c},getSticker:function(b){return a.me.sync.models[i].stickers[b]},isPublicModel:function(){return a.sync.public.models&&!!a.sync.public.models[i]},getModelPermission:function(){return a.sync.user.models?a.sync.user.models[i]:null},isMyModel:function(){return!!a.getModelPermission()},isModelEditable:function(){return d.contains(k,a.getModelPermission())},isModelFullAccess:function(){return d.contains(l,a.getModelPermission())}}),a.layout.tooltips=!0,a.layout.setView("canvas"),a.layout.guide.wide=!1,a.layout.peer.wide=!1,a.layout.qrCode=!1,a.canvas.setModel(i,a.me.sync.models[i])}]),FirstRevenueApp.controller("CommentController",["$scope","_",function(a,b){var c="CommentController";console.log(c,"started"),angular.extend(a,{comment:{id:null,sort:"-updated"},getCurrentModel:function(){return a.sync.models[a.canvas.modelId]},getComments:function(){var c=a.getCurrentModel();return b.sortBy(c.comments,function(a){return-a.updated})},openComment:function(){var b=a.getCurrentModel();a.comment.id=a.me.userRef.push().name(),b.comments=b.comments||{},b.comments[a.comment.id]={id:a.comment.id,author:a.me.userId,updated:Date.now(),text:""}},closeComment:function(){var b=a.getCurrentModel(),c=b.comments[a.comment.id];c.updated=Date.now(),c.created||(c.created=c.updated),a.comment.id=null},modifyComment:function(b){a.comment.id=b.id},getDateUpdated:function(b){return b.updated?a.getLatency(new Date(b.updated),Date.now()):null},getDateCreated:function(b){return b.created?a.getLatency(new Date(b.created),Date.now()):null},getCommentLatency:function(b){return b?a.getLatency(new Date(b),Date.now()):null},getRefreshLatency:function(b){return a.timeStamp=Date.now(),b?a.getLatency(b,a.timeStamp):""}})}]),FirstRevenueApp.controller("ContactController",["$scope","$timeout","_","Social","Myself",function(a,b,c,d,e){var f="ContactController";console.log(f,"Entered");var g=e;angular.extend(a,{service:null,account:null,contactProvider:null,accountId:null,timeStamp:null,social:d,init:function(b){a.service=b,a.account=c.find(g.sync.user.accounts,function(a){return a.profile.service===b})},saveContacts:function(){},setAccount:function(b){a.accountId=b},getAccounts:function(){return g.getAccounts()},getPartners:function(){var a={};return angular.forEach(g.sync.user.accounts,function(b){b.contacts&&angular.forEach(b.contacts.partners,function(c,d){c.service=b.profile.service,a[d]=c})}),a},getPartnerCount:function(){return c.size(a.getPartners())},getFavoriteCount:function(){return c.size(c.where(a.getPartners(),{favorite:!0}))},isPartner:function(a){return!!a.partner},isFavorite:function(a){return a.partner&&a.partner.favorite},toggleFavorite:function(b){if(console.log(f,"toggleFavorite contact=",b),!b.partner){var c=a.me.sync.user.accounts[b.profileKey].contacts;c.partners||(c.partners={}),c.partners[b.serviceId]||(c.partners[b.serviceId]={name:b.name,image:b.image}),b.partner=c.partners[b.serviceId]}b.partner.favorite=!b.partner.favorite,console.log(f,"toggleFavorite contact.partner=",b.partner)},getSocialPartners:function(b){console.log(f,"getSocialPartners service=",b);var c={},d=a.account;return console.log(f,"getSocialPartners account=",d),a.account&&a.account.contacts&&angular.forEach(a.account.contacts.partners,function(a,b){c[b]={provider:d.profile.provider,service:d.profile.service,name:a.name,image:a.image,id:b,partner:a}}),console.log(f,"getSocialPartners contacts=",c),c},getContacts:function(b){return console.log(f,"getContacts service=",b),d.loaded[b]?d.contacts[b]:a.getSocialPartners(b)},getSocialPartnerIds:function(b){return console.log(f,"getSocialPartnerIds service=",b),a.account.contacts?c.keys(a.account.contacts.partners):[]},getContactIds:function(b){return console.log(f,"getContactIds service=",b),d.loaded[b]?d.contacts[b]:a.getSocialPartnerIds(b)},getSocialContacts:function(a){console.log(f,"getSocialContacts service=",a);var b=c.find(g.user.accounts,function(b){return console.log(f,"getSocialContacts account=",b),b.profile.service===a});return console.log(f,"getSocialContacts found account=",b),b.allContacts},getContactCount:function(a){var b=g.findAccount(a).contacts;return b&&b.total||0},getRefreshTime:function(a){var b=g.findAccount(a).contacts,c=b&&b.refreshed;return c?new Date(c).toString():null},getRefreshLatency:function(c){var d=g.findAccount(c).contacts,e=d&&d.refreshed||0,f="";if(e){b(function(){a.timeStamp=Date.now()},1e3);var h=Math.round((Date.now()-e)/1e3);1>h?f="just now":60>h?f=h+" second"+a.numberEnding(h)+" ago":3600>h?(h=Math.round(h/60),f=h+" minute"+a.numberEnding(h)+" ago"):86400>h?(h=Math.round(h/60/60),f=h+" hour"+a.numberEnding(h)+" ago"):(h=Math.round(h/60/60/24),f=h+" day"+a.numberEnding(h)+" ago")}else f="never";return f},numberEnding:function(a){return 1===a?"":"s"},hasBeenInvited:function(a){return!!a.inviteSent},hasNoInvitation:function(a){return!a.inviteSent&&!a.account},invite:function(a,b){d.createInvite(a,b)},isUser:function(a){return!!a.account}}),a.layout.setGuideWidth(),a.layout.peer.wide=!1}]),FirstRevenueApp.controller("EntryController",["$scope","$location","$timeout","Auth","Modal","Register",function(a,b,c,d,e,f){var g="EntryController";console.log(g,"Entry route invoked Modal=",e,"Auth=",d),angular.extend(a,{modal:e,auth:d,logonTabName:"persona",register:f,personaFound:null!==navigator.id,logon:function(){console.log(g,"logon"),a.modal.logon=!0},providerList:function(){var a=[];return angular.forEach(f.providers,function(b,c){a.push(angular.extend(b,{provider:c}))}),a}}),a.auth.accepted=!1,a.layout.setView("signin"),a.layout.guide.wide=!1,a.layout.peer.wide=!1,a.menu.setTitle("Welcome to the "+a.appName),a.menu.selected="logon",a.menu.visible=["home","logon"]}]),FirstRevenueApp.controller("HeaderController",["$scope","$location","Modal","Zoom","Model","Info",function(a,b,c,d,e,f){angular.extend(a,{modal:c,zoom:d,model:e,info:f,modelNameEditing:!1,admin:function(){a.me.sync.admin.status&&(a.me.sync.collectAdminData(a.me.rootRef),b.path("/admin"))},modifyAccount:function(){a.modal.logoff=!0},preferences:function(){a.modal.logoff=!0},logoff:function(){a.modal.logoff=!0}})}]),FirstRevenueApp.controller("HomeController",["$scope","_","ModelCatalog",function(a,b,c){var d="HomeController";console.log(d,"route invoked"),angular.extend(a,{catalog:c,getActiveAccounts:function(){var c=[];return angular.forEach(a.firebase.providers,function(d,e){var f=b.find(a.sync.user.accounts,function(a){return a.profile.service===e});f&&c.push(f)}),c},getUnusedProviders:function(){var c=[];return angular.forEach(a.firebase.providers,function(d,e){var f=b.find(a.sync.user.accounts,function(a){return a.profile.service===e});f||c.push(d)}),c}}),a.layout.setGuideWidth(),console.log(d,"layout.guide=",a.layout.guide),a.layout.peer.wide=!1,a.menu.setTitle(a.appName+" Dashboard"),a.menu.selected="home",a.menu.visible=["home","repo"]}]),FirstRevenueApp.controller("HomeTabsController",["$scope",function(a){console.log("---- HomeTabsController"),a.menu.selected="home",a.menu.visible=["home","repo"],a.canvas.model&&a.menu.visible.push("canvas"),angular.extend(a,{homeTabName:"welcome",adminTitle:function(){return a.user.adminRole?"Administration":""},monitoringTitle:function(){return a.user.adminRole?"Monitoring":""},webFormsTitle:function(){return a.user.adminRole?"Podio Web Forms":""}})}]),FirstRevenueApp.controller("ImpressController",["$scope","$route",function(a,b){var c="ImpressController";console.log(c,"invoked");var d={KP:{iconId:106,initials:"KP",name:"Key Partnerships"},KA:{iconId:51,initials:"KA",name:"Key Activities"},KR:{iconId:82,initials:"KR",name:"Key Resources"},VP:{iconId:89,initials:"VP",name:"Value Propositions"},CR:{iconId:83,initials:"CR",name:"Customer Relationships"},CH:{iconId:261,initials:"CH",name:"Channels"},CS:{iconId:175,initials:"CS",name:"Customer Segments"},CX:{iconId:165,initials:"C$",name:"Cost Structure"},RX:{iconId:200,initials:"R$",name:"Revenue Streams"}};angular.extend(a,{modelId:null,getBlocks:function(){return d},getStickers:function(b){var c={},d=a.im.model;return d&&d.stickers&&angular.forEach(a.im.model.stickers,function(a,d){a.block===b&&(c[d]=a)}),c}}),a.modelId=b.current.params.modelId,console.log(c,"$route=",b,"modelId=",a.modelId),a.modelId&&a.im.loadModel(a.modelId)}]),FirstRevenueApp.controller("ImpressMasterController",["$scope","$route","$routeParams","$window","Canvas","ImpressModel",function(a,b,c,d,e,f){var g="ImpressMasterController";console.log(g,"launched"),angular.extend(a,{canvas:e,im:f}),a.rootRef=new Firebase(CONFIG_1ST_REVENUE.firebaseEndpoint),d.document.title=a.appName+" Presentation",f.init(a.rootRef,a),console.log(g,"$route=",b,"modelId=",a.modelId,"$routeParams=",c),analytics.track("Impress launch")}]),FirstRevenueApp.controller("InviteController",["$scope","$location","$timeout","$route","$q","Firebase","Invite",function(a,b,c,d,e,f,g){var h="InviteController",i="-0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ_abcdefghijklmnopqrstuvwxyz";angular.extend(a,{invite:g,inviteId:null,service:null,loaded:!1,creator:null,openAuth:function(){var b=a.inviteId=d.current.params.inviteId,i=e.defer();console.log(h,"openAuth $scope=",a,"inviteId=",b),g.inviteRef=f.rootRef.child("invites").child(b),g.inviteRef.once("value",function(b){var d=b.val();console.log(h,"openAuth inviteValue=",d),c(function(){a.invite.loaded=!0,a.me.sessionFound&&(a.me.mp.wasCurrentUserInvited(d)?(d.current=!0,i.resolve(d)):i.resolve(d)),i.resolve(d),a.service=d?d.service:null,a.me.sessionFound&&a.loadCreator(d),console.log(h,"invite value=",d)})},function(a){console.log("Invite error=",a),i.reject(a)}),g.setInvite(b,i.promise)},loadCreator:function(a){g.creatorRef=f.rootRef.child("users").child(a.creator).child("profile"),g.creatorRef.once("value",function(a){c(function(){g.creator=a.val()})})},extractTimeStamp:function(a){for(var b=a.substr(0,8),c=0,d=0;8>d;d++)c=64*c+i.indexOf(b.charAt(d));return c},getInviteDate:function(b){return new Date(a.extractTimeStamp(b)).toLocaleString()},signIn:function(){b.path("/entry")}}),a.invite.loaded=!1,a.invite.creator=null,a.openAuth()}]),FirstRevenueApp.controller("MasterController",["$scope","$location","$route","$routeParams","AppName","Sync","Layout","Popup","Menu","Notif","Firebase","Canvas","Myself","Favicon","RrrrRrrr",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o){var p="MasterController";console.log(p,"launched"),angular.extend(a,{appName:e,layout:g,popup:h,menu:i,notif:j,firebase:k,canvas:l,me:m,sync:f,favicon:n,ribbon:{peerCount:function(){return 0}},rrrr:o,rrrrImageLink:o.getImageLink(),logoff:function(){a.user.logoff(),a.me.logoff()},getSize:function(a){return _.size(a)},getLatency:function(a,b){var c=Math.round((b-a)/1e3),d="";return 1>c?d="just now":60>c?d=c+"s ago":3600>c?(c=Math.round(c/60),d=c+" min ago"):86400>c?(c=Math.round(c/60/60),d=c+"h ago"):(c=Math.round(c/60/60/24),d=new Date(+a).toISOString().substr(0,10)),d},numberEnding:function(a){return 1===a?"":"s"}}),a.layout.reset(),a.me.authenticated=!1,a.menu.setTitle(e),k.init(),f.init(a),m.init(b.path());var q="/invite/";b.path().substring(0,q.length)===q?(a.firebase.retrieveSession(),console.log(p,"Firebase retrieveSession() done $location.path()=",b.path())):(a.firebase.resumeSession(),console.log(p,"Firebase resumeSession() done $location.path()=",b.path())),a.notif.add({text:e+" started"}),analytics.track("App launch")}]),FirstRevenueApp.controller("MembersController",["$scope","MemberCatalog",function(a,b){angular.extend(a,{catalog:b}),a.catalog.sort=a.catalog.sort||"name"}]),FirstRevenueApp.controller("ModalController",["$scope","$location","Modal","StickerEditor",function(a,b,c,d){var e="ModalController";console.log(e,"Launched"),angular.extend(a,{modal:c,editor:d,modelName:null,logoff:function(){this.modal.logoff=!1,a.me.authenticated=!1,a.me.authFailed=!0,a.firebase.rootRef.unauth(),FirebaseSimpleLogin.prototype.clearSession(),a.me.logoff(),b.url("/entry")},deleteCookie:function(a){document.cookie=a+'="";-1; path=/'},discardStickerChanges:function(){this.modal.dis=!1,this.editor.discardChanges(),this.editor.sticker=null,a.layout.editor.sticker=!1,a.layout.tooltips=!0},keepStickerChanges:function(){this.modal.dis=!1,a.layout.tooltips=!0},deleteSticker:function(){console.log(e,"deleteSticker"),delete a.me.sync.models[a.canvas.modelId].stickers[this.modal.stickerId],this.modal.stickerId=null,this.modal.sticker=null,a.layout.editor.sticker=!1,this.modal.del=!1,a.layout.tooltips=!0},leaveSticker:function(){this.modal.del=!1,a.layout.tooltips=!0}})}]),FirstRevenueApp.controller("ModelController",["$scope","$location","$timeout","_","Social","FilePicker",function(a,b,c,d,e,f){var g="ModelController";console.log(g,"started");var h={facebook:"Facebook",linkedin:"LinkedIn",gplus:"Google+",gmail:"Gmail"},i=window.location.origin||window.location.protocol+"//"+window.location.host,j=i+window.location.pathname+"#/invite/",k=i+window.location.pathname+"views/GooglePlusInvitation.html";angular.extend(a,{social:e,fp:f,googleClientId:CONFIG_1ST_REVENUE.googleClientId,callToActionURL:j,contentURL:k,repoList:[],newModelName:"",model:{editorTab:0,commentId:null,commentSort:"-updated"},tah:{empty:!0,userTypeAhead:"",selectedDatum:null,dataset:null,social:{},partners:{}},selectedUsers:{},nameError:!1,emptyDataset:{name:"empty",count:0,template:a.template,header:'<div class="tt-header">No users found</div>',local:[]},picks:{invites:!0,users:!0,groups:!0,partners:!0,social:!0},businessCard:null,sectionHelp:{invites:!1,users:!1,groups:!1,partners:!1,social:!1},getCurrentModel:function(){return a.sync.models[a.canvas.modelId]},getComments:function(){return d.sortBy(a.getCurrentModel().comments,function(a){return-a.updated})},openComment:function(){var b=a.getCurrentModel();a.model.commentId=a.me.userRef.push().name(),b.comments=b.comments||{},b.comments[a.model.commentId]={id:a.model.commentId,author:a.me.userId,updated:Date.now(),text:""}},closeComment:function(){var b=a.getCurrentModel(),c=b.comments[a.model.commentId];c.updated=Date.now(),c.created||(c.created=c.updated),a.model.commentId=null},modifyComment:function(b){a.model.commentId=b.id},getDateUpdated:function(b){return b.updated?a.getLatency(new Date(b.updated),Date.now()):null},getDateCreated:function(b){return b.created?a.getLatency(new Date(b.created),Date.now()):null},getCommentLatency:function(b){return b?a.getLatency(new Date(b),Date.now()):null},resetSearch:function(){a.tah.userTypeAhead="",a.tah.selectedDatum=null},massInviteAllowed:function(){return!1},tahSubmit:function(){console.log(g,"tahSubmit tah.userTypeAhead=",a.tah.userTypeAhead),e.addModelInvite(a.canvas,a.tah.selectedDatum),a.resetSearch()},deletePeer:function(b){var c=a.getCurrentModel();console.log(g,"deletePeer userId=",b),delete c.users[b],console.log(g,"deletePeer deleted model user userId=",b),d.find(c.invites,function(d,e){return a.sync.invites[e].userId===b?(delete c.invites[e],console.log(g,"deletePeer deleted model invite inviteId=",e),!0):void 0})},deleteInvite:function(b){console.log(g,"deleteInvite inviteId=",b);var c=a.canvas.modelId;delete a.sync.models[c].invites[b],delete a.sync.invites[b].models[c],delete a.sync.user.invites[b]},getRefreshLatency:function(b){return a.timeStamp=Date.now(),b?a.getLatency(b,a.timeStamp):""},getRepos:function(){var a=this.repoList=[];return a},deleteModelRef:function(){console.log(g,"model delete remove model ref from user modelId=",a.canvas.modelId),delete a.sync.user.models[a.canvas.modelId],console.log(g,"model delete set model to null modelId=",a.canvas.modelId),a.sync.models[a.canvas.modelId]=null,console.log(g,"model delete done models[id]=",a.sync.models[a.canvas.modelId]),a.modal.model=!1,b.path("/repo")},finish:function(){a.layout.setView("canvas")},manageUsers:function(){a.layout.setView("users")},showModels:function(){a.fpFile=null,b.path("/repo")},pitchWordCount:function(){var b=a.getCurrentModel(),c=b.fields.pitch?b.fields.pitch:"";return""===c?0:c.split(/\s+/).length},pitchRed:function(){var a=this.pitchWordCount(),b=Math.min(100,a);return Math.round(255*b/100)},pitchGreen:function(){var a=this.pitchWordCount(),b=Math.min(100,a);return 160-Math.round(160*b/100)},addUser:function(){},getUserTypeahead:function(){var b=[];return angular.forEach(a.sync.user.accounts,function(a){a.contacts&&angular.forEach(a.contacts.partners,function(c,d){var e={provider:a.profile.provider,service:a.profile.service,serviceId:d,name:c.name,value:c.name,tokens:c.name.split(" "),image:c.image};b.push(e)})}),b},header:function(a){return console.log(g,"header data=",a),'<div class="tt-header">'+a.name+" partners ("+a.count+")</div"},template:function(a){return'<img src="'+(a.image?a.image:"images/bbf82395.light_avatar_small.png")+'" /><div class="tt-name">'+a.name+'</div><div class="tt-user-id">'+a.serviceId+"</div>"},preparePartnerMarks:function(){angular.forEach(a.sync.user.accounts,function(b){a.tah.partners[b.profile.service]=!0})},createDataset:function(b,c,e){var f=h[e.profile.service]||"Unknown",i={name:e.profile.service+"-"+b,count:e.contacts.total,service:e.profile.service,serviceTitle:f,template:a.template,header:'<div class="tt-header">'+f+" "+b+" ("+d.size(c)+")</div>",local:c};return console.log(g,"createDataset "+b+" dataset=",i),i},buildDatasetItem:function(a){return function(b,c){var d=b.name.split(" ");d.push("*");var e={account:a,provider:a.profile.provider,service:a.profile.service,serviceId:c,name:b.name,value:b.name,tokens:d,image:b.image};return console.log(g,"buildDatasets partners partnerData=",b,"key=",c,"partner=",e),e}},buildDatasets:function(){console.log(g,"buildDatasets");var b=[];angular.forEach(a.sync.user.accounts,function(c){if(console.log(g,"buildDatasets account=",c),a.social.loaded[c.profile.service]&&a.tah.social[c.profile.service]){var e=d.map(a.social.contacts[c.profile.service],a.buildDatasetItem(c));b.push(a.createDataset("friends",e,c))}}),a.tah.empty=0===d.size(b),a.tah.empty&&b.push(a.emptyDataset),c(function(){console.log(g,"buildDatasets tah.dataset=",b),a.tah.dataset=b})},loadAccount:function(b){a.social.fetchAccount(a.me,b.profile.service),a.tah.social[b.profile.service]=!0,a.picks[b.profile.service]=!0},refreshAccount:function(b){a.social.fetchAccount(a.me,b.profile.service)},getPartners:function(){return d.toArray(a.sync.user.partners)},canManageModel:function(){var b=a.me.userId,c=a.canvas.modelId,d=a.sync.models[c],e=d&&"full"===d.users[b],f=d&&d.owner===b;return f||e},showUserRemoveButton:function(b){var c=a.me.userId,d=b===c;return!d&&a.canManageModel()},showInviteRemoveButton:function(b){var c=a.me.userId,d=a.sync.invites[b],e=d&&d.creator===c;return e||a.canManageModel()},prefixFilter:function(b){for(var c=a.tah.userTypeAhead.toLowerCase(),d=c.length,e=b.name.toLowerCase().split(" "),f=0;f<e.length;f++)if(e[f].slice(0,d)===c)return!0;return!1},pickGroup:function(b){a.picks[b]=!a.picks[b]},isPickVisible:function(b){return!!a.picks[b]},partnersLoaded:function(){return!(d.isEmpty(a.sync.user.groups)&&d.isEmpty(a.sync.user.partners)&&a.tah.empty)},wasInvited:function(b){var c,e,f=a.getCurrentModel();return e=d.find(f.users,function(c,d){var e=a.sync.peers[d];return e&&b.service===e.service&&b.serviceId===e.serviceId}),d.isUndefined(e)&&(c=d.find(f.invites,function(c,d){var e=a.sync.invites[d];return e&&!e.userId&&b.service===e.service&&b.serviceId===e.serviceId})),!(d.isUndefined(e)&&d.isUndefined(c))},countInvites:function(){var b=a.getCurrentModel();return b&&b.invites?d.reduce(b.invites,a.injectInviteCount,0):0},injectInviteCount:function(b,c,d){var e=a.sync.invites&&a.sync.invites[d];return b+(e&&"accepted"!==e.status?1:0)},showSelectButton:function(b){var c=a.getCurrentModel(),d=a.me.userId;return!a.wasInvited(b)&&c&&(c.owner===d||"full"===c.users[d])},showInviteCard:function(b){var c=a.sync.invites&&a.sync.invites[b];a.showBusinessCard("invite",c,b)},showUserCard:function(b){var c=a.sync.peers[b];a.showBusinessCard("user",c,b)},showBusinessCard:function(b,c,d){console.log(g,"showBusinessCard type=",b,"user=",c,"id=",d);var e=c.image;switch("facebook"===c.service?e="https://graph.facebook.com/"+c.serviceId+"/picture?type=large":"gplus"===c.service&&(e=e.slice(0,-2)+"200"),a.businessCard={type:b,name:c.name,image:e,email:c.email,serviceTitle:h[c.service],serviceId:c.serviceId,description:c.description,work:c.work},b){case"invite":a.businessCard.inviteId=d;break;case"user":a.businessCard.userId=d}},hideBusinessCard:function(){console.log(g,"hideBusinessCard"),a.businessCard=null},toggleHelp:function(b){a.sectionHelp[b]=!a.sectionHelp[b]},showHelp:function(b){return!!a.sectionHelp[b]},getDefaultPermission:function(a){return console.log(g,"getDefaultPermission","businessCard=",a),"none"},getModelPermission:function(b){console.log(g,"getModelPermission","businessCard=",b);var c=a.getCurrentModel();return b.userId?c.users[b.userId]:b.inviteId?c.invites[b.inviteId]:"none"},getDefaultPopoverContent:function(a){var b='             <div class="btn-group" data-toggle="buttons">               <label class="btn btn-info">                 <input type="radio" name="options" id="default-none">None               </label>               <label class="btn btn-success">                 <input type="radio" name="options" id="default-view">View               </label>               <label class="btn btn-warning">                 <input type="radio" name="options" id="default-edit">Edit               </label>               <label class="btn btn-danger">                 <input type="radio" name="options" id="default-full">Full               </label>             </div>';return console.log(g,"getDefaultPopoverContent","businessCard=",a),b}}),a.menu.selected="canvas",a.social.me=a.me,a.preparePartnerMarks(),a.buildDatasets(),a.$watch("sync.user.accounts",a.buildDatasets,!0),a.$watch("social.contacts",a.buildDatasets,!0)}]),FirstRevenueApp.controller("ModelsController",["$scope","ModelCatalog","Zoom",function(a,b,c){var d="ModelsController";console.log(d,"invoked"),angular.extend(a,{catalog:b,zoom:c}),a.menu.setTitle(a.appName+" Repository"),a.menu.selected="repo",a.menu.visible=["home","repo"],a.canvas.model&&a.menu.visible.push("canvas"),a.catalog.sort=a.catalog.sort||"time",a.catalog.tag=a.catalog.tag||"*"}]),FirstRevenueApp.controller("MonitorController",["$scope","Monitor",function(a,b){angular.extend(a,{monitor:b,getRateStats:function(){b.getRateStats(function(){a.$root.$apply()})},timeStamp:function(a){var b="";return isNaN(parseInt(a,10))||(b=new Date(6e4*a).toISOString()),b}})}]),FirstRevenueApp.controller("NewModelController",["$scope","$location",function(a,b){var c="NewModelController";a.layout.peer.wide=!1,a.menu.setTitle("Create Model"),a.menu.selected="create",console.log(c,"launched"),angular.extend(a,{newModel:{},nameError:!1,createModel:function(d){console.log(c,"createModel name=",d),""===d?a.nameError=!0:(a.nameError=!1,a.menu.setTitle(d),console.log(c,"calling Firebase.createModel newModelName=",d),a.newModel.id=a.firebase.createModel(d,function(){console.log(c,"model create callback newModelId=",a.newModel.id),a.canvas.modelId=a.newModel.id,a.canvas.model=a.sync.models[a.newModel.id],b.path("/canvas/"+a.newModel.id)}))},cancel:function(){a.layout.setView(a.layout.lastRepoView)}})}]),FirstRevenueApp.controller("NotifController",["$scope",function(a){console.log("--- NotifController $scope=",a)}]),FirstRevenueApp.controller("PeopleController",["$scope","Social","Myself",function(a,b,c){console.log("---- PeopleController");var d=c;angular.extend(a,{contactProvider:null,accountId:null,saveContacts:function(){},setAccount:function(b){a.accountId=b},getAccounts:function(){return d.getAccounts()},getContacts:function(){return d.getContacts(a.accountId)}}),a.layout.setView("partners"),a.layout.setGuideWidth(),a.layout.peer.wide=!1}]),FirstRevenueApp.controller("PrefController",["$scope","Rainbow",function(a,b){a.menu.setTitle(a.appName+" Preferences"),console.log("Preferences route invoked"),a.brighten=b.brightenFull}]),FirstRevenueApp.controller("ProjectListController",["$scope","Renderer","Rainbow",function(a,b,c){var d="ProjectListController",e={branch:"#b2b19d",code:"orange",doc:"#922E00",demo:"#a7af00"};console.log(d,"invoked"),angular.extend(a,{getProjectDemoData:function(){return a.demoData},getProjectData:function(){var b={nodes:{},edges:{}},d=a.sync.user.profile.name;return b.nodes[d]={color:"blue",shape:"dot",alpha:1},b.edges[d]={},angular.forEach(a.sync.user.models,function(e,f){var g=a.sync.models[f];b.nodes[g.fields.name]={color:"red",alpha:1},b.edges[d][g.fields.name]={length:1},b.edges[g.fields.name]={},angular.forEach(g.stickers,function(a){b.nodes[a.title]={color:"#"+c.brighten(a.color),shape:"square",alpha:1},b.edges[g.fields.name][a.title]={}})}),b},demoData:{nodes:{"1R Model":{color:"red",shape:"dot",alpha:1},MetaData:{color:e.branch,shape:"dot",alpha:1},Pitch:{color:e.demo,alpha:1,link:"https://netbmgrepository.podio.com/netbmg-business-model/item/12589021"},Web:{color:e.demo,alpha:1,link:"https://netbmgrepository.podio.com/netbmg-business-model/item/12589147"},Description:{color:e.demo,alpha:1,link:"https://netbmgrepository.podio.com/netbmg-business-model/item/12589125"},Team:{color:e.branch,shape:"dot",alpha:1},Terje:{color:e.doc,alpha:1,link:"https://podio.com/users/573093"},Edmundas:{color:e.doc,alpha:1,link:"https://podio.com/users/639605"},MarketTrends:{color:e.branch,shape:"dot",alpha:1},"Focus on Business Model Generation":{color:e.doc,alpha:1,link:"https://netbmgrepository.podio.com/netbmg-business-model/item/12827502"},Article2:{color:e.doc,alpha:1,link:"https://podio.com/users/639605"},Competitors:{color:e.branch,shape:"dot",alpha:1},LeanLaunchLab:{color:e.code,alpha:1,link:"https://netbmgrepository.podio.com/netbmg-business-model/item/11364419"},"Business Model Toolbox (iPad app)":{color:e.code,alpha:1,link:"https://netbmgrepository.podio.com/netbmg-business-model/item/11364415"},Strategyzr:{color:e.code,alpha:1,link:"https://netbmgrepository.podio.com/netbmg-business-model/item/11364417"},CustSegm:{color:e.branch,shape:"dot",alpha:1},Users:{color:e.code,shape:"dot",alpha:1},Mentors:{color:e.code,shape:"dot",alpha:1},Incubators:{color:e.code,shape:"dot",alpha:1},Forskningsparken:{color:e.code,alpha:1,link:"https://netbmgrepository.podio.com/netbmg-business-model/item/11365132"},"Kjeller Innovasjon":{color:e.code,alpha:1,link:"https://netbmgrepository.podio.com/netbmg-business-model/item/11365125"},"BTO (Bergen Technology Transfer Office)":{color:e.code,alpha:1,link:"https://netbmgrepository.podio.com/netbmg-business-model/item/11365051"},SegmChan:{color:e.branch,shape:"dot",alpha:1},"Social media":{color:e.code,shape:"dot",alpha:1},"Traditional sales":{color:e.code,shape:"dot",alpha:1},Twitter:{color:e.code,shape:"dot",alpha:1},Facebook:{color:e.code,shape:"dot",alpha:1},"Sales meetings":{color:e.code,shape:"dot",alpha:1},"Educational institutions":{color:e.code,alpha:1,link:"https://netbmgrepository.podio.com/netbmg-business-model/item/6163425"},"BMG Consulting companies":{color:e.code,alpha:1,link:"https://netbmgrepository.podio.com/netbmg-business-model/item/6163083"}},edges:{"1R Model":{MetaData:{length:.8},Team:{length:.8},MarketTrends:{length:.8},Competitors:{length:.8},SegmChan:{length:.8},CustSegm:{length:.8}},MetaData:{Pitch:{},Web:{},Description:{}},Team:{Terje:{},Edmundas:{}},MarketTrends:{"Focus on Business Model Generation":{},Article2:{}},Competitors:{"Business Model Toolbox (iPad app)":{},Strategyzr:{},LeanLaunchLab:{}},CustSegm:{Users:{},Mentors:{},Incubators:{}},SegmChan:{"Social media":{},"Traditional sales":{}},"Social media":{Twitter:{},Facebook:{}},"Traditional sales":{"Sales meetings":{}},"Sales meetings":{"Educational institutions":{},"BMG Consulting companies":{}},Incubators:{Forskningsparken:{},"Kjeller Innovasjon":{},"BTO (Bergen Technology Transfer Office)":{}}}}}),a.menu.setTitle("Projects"),b.render("#project-map",a.getProjectData())}]),FirstRevenueApp.controller("RegisterController",["$scope","_","Register","Credentials",function(a,b,c,d){var e="RegisterController";console.log(e,"launched"),angular.extend(a,{register:c,cr:d});var f=c.init();d.init(f),a.menu.setTitle("Register to the "+a.appName)}]),FirstRevenueApp.controller("RepoController",["$scope","_","ModelCatalog","Modal","RrrrRrrr",function(a,b,c,d,e){var f="RepoController";console.log(f,"launched"),angular.extend(a,{catalog:c,modal:d,modelTabName:"models",rrrrImageLink:e.getImageLink()});var g=b.size(a.catalog.getModelIdList("my")),h=b.size(a.catalog.getModelIdList("shared"));a.layout.setView(h&&!g?"shared":"my"),a.layout.setGuideWidth(),console.log(f,"layout.guide=",a.layout.guide),a.layout.peer.wide=!1}]),FirstRevenueApp.controller("RibbonController",["$scope","$location","$window","_",function(a,b,c,d){var e="RibbonController";console.log(e,"loaded");var f={gplus:{icon:"google-plus",label:"Google+"},gmail:{icon:"envelope",label:"Gmail"},facebook:{label:"Facebook"},linkedin:{label:"LinkedIn"}};angular.extend(a,{ribbon:a.layout.guide,routeTo:function(a){b.path("/"+a)},getSocialIconName:function(a){var b=a.profile.service,c=f[b];return"icon-"+(c&&c.icon||b)},getSocialLabel:function(a){var b=a.profile.service,c=f[b];return c&&c.label||b},getModelUserIds:function(){return d.keys(a.canvas.model&&a.canvas.model.users||{})},toggleShare:function(){a.layout.share=!a.layout.share,a.layout.share
},toggleQRCode:function(){if(a.layout.qrCode=!a.layout.qrCode,a.layout.qrCode){var b=c.location.origin||c.location.protocol+"//"+c.location.host,d=b+c.location.pathname,e=d+"#/canvas"+a.canvas.modelId,f=new JSQR,g=new f.Code;g.encodeMode=g.ENCODE_MODE.UTF8_SIGNATURE,g.version=7,g.errorCorrection=g.ERROR_CORRECTION.Q;var h=new f.Input;h.dataType=h.DATA_TYPE.URL,h.data={url:e};var i=new f.Matrix(h,g);i.scale=7;var j=document.createElement("canvas");j.setAttribute("width",i.pixelWidth),j.setAttribute("height",i.pixelWidth),j.getContext("2d").fillStyle="rgb(0,0,0)",i.draw(j,0,0),$("#qrcode").empty(),$("#qrcode").append(j)}}}),c.UserVoice=c.UserVoice||[]}]),FirstRevenueApp.controller("SocialController",["$scope","$timeout","_","Social","Myself",function(a,b,c,d,e){var f="SocialController";console.log(f,"Entered");var g=e;angular.extend(a,{service:null,account:null,accountId:null,contactProvider:null,timeStamp:null,social:d,init:function(b){a.service=b,a.account=c.find(g.sync.user.accounts,function(a){return a.profile.service===b})},saveContacts:function(){},setAccount:function(b){a.accountId=b},isPartner:function(a){return!!a.partner},isFavorite:function(a){return a.partner&&a.partner.favorite},toggleFavorite:function(b){if(console.log(f,"toggleFavorite contact=",b),!b.partner){var c=a.me.sync.user.accounts[b.profileKey].contacts;c.partners||(c.partners={}),c.partners[b.id]||(c.partners[b.id]={name:b.name,image:b.image}),b.partner=c.partners[b.id]}b.partner.favorite=!b.partner.favorite,console.log(f,"toggleFavorite contact.partner=",b.partner)},getSocialPartners:function(a){console.log(f,"getSocialPartners service=",a);var b={},d=c.find(g.sync.user.accounts,function(b){return b.profile.service===a});return console.log(f,"getSocialPartners account=",d),angular.forEach(d.contacts.partners,function(a,c){b[c]={provider:d.profile.provider,service:d.profile.service,name:a.name,image:a.image,id:c,partner:a}}),console.log(f,"getSocialPartners contacts=",b),b},getContacts:function(b){return console.log(f,"getContacts service=",b),d.loaded[b]?d.contacts[b]:a.getSocialPartners(b)},getSocialContacts:function(a){console.log(f,"getSocialContacts service=",a);var b=c.find(g.user.accounts,function(b){return console.log(f,"getSocialContacts account=",b),b.profile.service===a});return console.log(f,"getSocialContacts found account=",b),b.allContacts},getContactCount:function(a){return g.findAccount(a).contacts.total},getRefreshTime:function(a){var b=g.findAccount(a).contacts.refreshed;return b?new Date(b).toString():null},getRefreshLatency:function(c){var d=g.findAccount(c).contacts.refreshed;return b(function(){a.timeStamp=Date.now()},1e3),a.getLatency(d,a.timeStamp)},hasBeenInvited:function(a){return!!a.inviteSent},hasNoInvitation:function(a){return!a.inviteSent&&!a.account},invite:function(b,c){console.log(f,"invite key=",b,"partner=",c);var e=g.userRef.child("invites").push();e.set({service:c.service,id:b}),c.invite=e.name();var h={service:c.service,id:b,status:"created",creator:g.userId},i=g.rootRef.child("invites").child(c.invite);i.set(h,function(b){a.inviteCallback(b,c,"created")}),d.invite(c,function(b){b&&(console.log(f,"invite sent partner=",c),i.update({status:"sent"},function(b){a.inviteCallback(b,c,"sent")}))})},inviteCallback:function(a,b,c){a?(console.log(f,"invite global status cannot be set to",c,"error=",a),b.inviteFailed=!0):(console.log(f,"invite global status set to",c),"created"===c&&(b.inviteCreated=!0),"sent"===c&&(b.inviteSent=!0))},isUser:function(a){return!!a.account}}),a.layout.setGuideWidth(),a.layout.peer.wide=!1}]),FirstRevenueApp.controller("StickerController",["$scope","StickerEditor","Modal",function(a,b,c){console.log("---- StickerController"),angular.extend(a,{modal:c,editor:b,titleOfDeleteButton:function(){return this.isDeleteAllowed()?"Delete sticker":"Not allowed to delete this sticker"},openDeleteStickerDialog:function(){var b=a.canvas.model.stickers[a.stickerId];this.modal.openDeleteStickerDialog(a.stickerId,b)},isDeleteAllowed:function(){return this.modal.isDeleteAllowed(a.stickerId)}})}]),FirstRevenueApp.controller("StickerEditorController",["$scope","_","StickerEditor","Info","Modal",function(a,b,c,d,e){console.log("---- StickerEditorController");var f=a.editor=c;a.$watch("Info.view.sticker",function(a){a&&f.focusTitle()}),angular.extend(a,{modal:e,purpose:"",confirmCloseEditor:function(){a.layout.editor.sticker=!1},confirmDeleteSticker:function(){this.modal.openDeleteStickerDialog(f.stickerId,f.sticker),a.layout.tooltips=!1},createSticker:function(){f.matchTitle()?(e.dup=!0,a.layout.tooltips=!1):(f.sticker.id=0,f.saveSticker())},saveSticker:function(){f.saveSticker()},isColorChosen:function(a){return f.sticker&&f.sticker.color&&f.sticker.color.toLowerCase()===a},isCancelButtonDisabled:function(){return!f.wasStickerModified()},isCloseButtonDisabled:function(){return f.wasStickerModified()},isDeleteButtonHidden:function(){return this.isStickerNew()},isDeleteButtonDisabled:function(){return!1},isNewButtonDisabled:function(){return!this.isStickerNew()&&this.matchTitle(f.sticker)},isSaveButtonDisabled:function(){return!f.wasStickerModified()},isStickerNew:function(){return!f.sticker||0===f.sticker.id},getBlock:function(){return a.getBlocks()[f.sticker.block]}})}]),FirstRevenueApp.controller("StickerListController",["$scope",function(a){var b="StickerListController";console.log(b,"started"),angular.extend(a,{list:{},getStickers2:function(b){var c={},d=a.canvas.modelId,e=a.me.sync.models[d];return e&&e.stickers&&angular.forEach(a.me.sync.models[d].stickers,function(a,d){a.block===b&&(c[d]=a)}),c}})}]),FirstRevenueApp.controller("ModelTagController",["$scope","TagCatalog",function(a,b){console.log("---- ModelTagController"),angular.extend(a,{catalog:b})}]),FirstRevenueApp.directive("uiModal",["$timeout",function(a){return{restrict:"EAC",require:"ngModel",link:function(b,c,d,e){c.addClass("modal hide"),b.$watch(d.ngModel,function(a){c.modal(a&&"show"||"hide")}),c.on("show.ui",function(){a(function(){e.$setViewValue(!0)})}),c.on("hide.ui",function(){a(function(){e.$setViewValue(!1)})})}}}]),FirstRevenueApp.directive("contenteditable",function(){return{restrict:"A",require:"?ngModel",link:function(a,b,c,d){function e(a){var b=a;return b}function f(){var a=b.html();c.stripBr&&"<br>"===a&&(a=""),c.singleLine&&(a=e(a)),d.$setViewValue(a)}d&&(b.bind("blur keyup change",function(){a.$apply(f)}),d.$render=function(){b.html(d.$viewValue||"")},f())}}}),FirstRevenueApp.directive("firstRevenueButtons",["Canvas","StickerEditor",function(a,b){return console.log("first-revenue-buttons"),function(c,d){d.on("click.first-revenue-buttons",".st-grad button",function(d){var e=$(this).offsetParent(),f=e.attr("data-pane"),g=e.attr("data-block"),h=e.attr("data-sticker");console.log("first-revenue-buttons pane=",f,"blockId=",g,"stickerId=",h),d.stopPropagation();var i=a.model.blocks;$(".pulsate").removeClass("pulsate"),angular.forEach(i,function(a){a.stickers[0]&&delete a.stickers[0]});var j=i[g],k=j.stickers[h],l=$(this).attr("title");if("Delete"===l)window.confirm("Delete sticker "+h+"\n"+k.title+"?");else if("Edit"===l){for(var m=0;m<Opentip.tips;m++)Opentip.tips[m].hide();var n=$(".st-grad[data-id="+h+"]");n.addClass("pulsate"),b.showSticker(a.model,j,h),console.log("first-revenue-buttons sticker=",k)}c.$root.$apply()})}}]),FirstRevenueApp.directive("firstRevenueDrag",[function(){return function(a,b){var c={opop:null,op:null,st:null,stl:0,stt:0,cl:0,ct:0,touchHandled:!1,touchMoved:!1,clicked:function(a){var b=$(a.target);if(!b.hasClass("btn")&&!b.offsetParent().hasClass("btn")){var d=c.op.offset(),e=c.st.offset();return c.stl=e.left-d.left,c.stt=e.top-d.top,c.cl=a.pageX-d.left,c.ct=a.pageY-d.top,c.opop.bind("mousemove",c.dragged),$(window).bind("mouseup",c.dropped),a.preventDefault(),!1}},dragged:function(b){a.$root.draggingActive=!0,a.layout.tooltips=!1,c.opop.addClass("drag-area"),c.st.addClass("st-dragged"),c.st.removeClass("st-show-buttons"),c.st.trigger("dragActive");var d=c.op.offset(),e=b.pageX-d.left,f=b.pageY-d.top,g=c.stl+(e-c.cl),h=c.stt+(f-c.ct);return g=Math.max(0,g),h=Math.max(0,h),g=Math.min(c.opop.width()-c.st.width(),g),h=Math.min(c.op.height(),h),c.st.css({position:"absolute",left:g,top:h}),!1},dropped:function(){return a.$root.draggingActive=!1,a.layout.tooltips=!0,c.opop.removeClass("drag-area"),c.st.removeClass("st-dragged"),c.opop.unbind("mousemove",c.dragged),$(window).unbind("mouseup",c.dropped),(!c.touchHandled||c.touchMoved)&&c.savePosition(),!1},savePosition:function(){var b=c.st.offset(),d=c.st.width(),e=c.opop.width()-d,f=c.op.height(),g=0===e?0:100*(b.left-c.op.offset().left)/e,h=0===f?0:100*(b.top-c.op.offset().top)/f,i=Math.max(0,Math.min(Math.round(100*g)/100,100)),j=Math.max(0,Math.min(Math.round(100*h)/100,100));console.log("first-revenue-drag xPerc=",i,"yPerc=",j,"sticker=",a.sticker,"sto=",b,"dh.opop.offset()=",c.opop.offset(),"dh.op.offset()=",c.op.offset()),c.st.css({position:"absolute",top:j+"%",left:i+"%"});var k=a.getSticker(a.stickerId);k.x=i,k.y=j,a.$apply()},touchStart:function(a){c.touchHandled||(c.touchHandled=!0,c.touchMoved=!1,c.simulateMouseEvent(a,"mousedown"))},touchMove:function(a){c.touchHandled&&(c.touchMoved=!0,c.simulateMouseEvent(a,"mousemove"))},touchEnd:function(a){c.touchHandled&&(c.simulateMouseEvent(a,"mouseup"),c.touchMoved||c.simulateMouseEvent(a,"click"),c.touchHandled=!1)},simulateMouseEvent:function(a,b){a.preventDefault();var d=a.originalEvent.changedTouches[0],e=document.createEvent("MouseEvents");if("click"===b)c.simulateEvent(e,b,d),a.target.dispatchEvent(e);else if("mousedown"===b){c.simulateEvent(e,b,d),c.clicked(e);var f=document.createEvent("MouseEvents");c.simulateEvent(f,"mousemove",d),c.dragged(f)}else"mousemove"===b?(c.simulateEvent(e,b,d),c.dragged(e)):"mouseup"===b&&(c.simulateEvent(e,b,d),c.dropped(e))},simulateEvent:function(a,b,c){return a.initMouseEvent(b,!0,!0,window,1,c.screenX,c.screenY,c.clientX,c.clientY,!1,!1,!1,!1,0,null)}},d=function(a){var b=a.offsetParent(),d=b;b.hasClass("pane")?b=b.find(".pane-sticker"):d=b.offsetParent(),c.opop=d,c.op=b,c.st=a,a.mousedown(c.clicked),"ontouchend"in document&&(a.bind("touchstart",c.touchStart),a.bind("touchmove",c.touchMove),a.bind("touchend",c.touchEnd))};d(b)}}]),FirstRevenueApp.directive("firstRevenueEdit",["Canvas","StickerEditor",function(a,b){var c="firstRevenueEdit";return console.log(c,"loaded"),function(d,e,f){var g=function(f,g){f.stopPropagation(),console.log(c,"scope=",d,"linkElement=",e,"$this=",g);var h=a.model,i=0,j=g;if($(".pulsate").removeClass("pulsate"),g.hasClass("pane")){var k=d.canvas.modelId,l=d.me.rootRef.child("models").child(k);i=l.child("stickers").push().name(),console.log(c,"create sticker stickerId=",i),d.sync.models[k].stickers=d.sync.models[k].stickers||{},d.sync.models[k].stickers[i]={title:"",notes:"",color:"yellow",block:j.attr("data-id")}}else j=g.offsetParent().offsetParent(),i=g.attr("data-id"),console.log(c,"existing sticker stickerId=",i),g.addClass("pulsate");var m=j.attr("data-id");b.showSticker(h,m,i),console.log(c,"editor.sticker=",b.sticker),d.$apply()};e.on("dblclick.st-edit",function(b){var c=$(this),d=f.firstRevenueEdit;a.singleBlock&&"XXC"!==d||g(b,c)}),e.on("click.st-edit",".pane-button",function(b){var c=$(this).offsetParent(),d=f.firstRevenueEdit;a.singleBlock&&"XXC"!==d||g(b,c)})}}]),FirstRevenueApp.directive("firstRevenueGapiInteractivePost",[function(){var a="firstRevenueGapiInteractivePost",b=window.location.origin||window.location.protocol+"//"+window.location.host,c=b+window.location.pathname+"#/invite/",d=b+window.location.pathname+"views/GooglePlusInvitation.html";return{restrict:"A",link:function(b,e,f){var g=f.firstRevenueGapiInteractivePost,h={contenturl:d,clientid:CONFIG_1ST_REVENUE.googleClientId,cookiepolicy:"single_host_origin",prefilltext:"Join the "+b.appName+" to collaborate on model "+b.canvas.model.fields.name,calltoactionlabel:"INVITE",calltoactionurl:c+b.inviteId,recipients:g};console.log(a,"Interactive post options=",h),gapi.interactivepost.render(e[0],h)}}}]),FirstRevenueApp.directive("firstRevenueOpenTip",["$window",function(a){var b=function(b){var c=b.currentTarget,d=$(c).offset(),e=d.left+c.clientWidth/2,f=d.top+c.clientHeight/2;return{hp:e,vp:f,ww:a.innerWidth,wh:a.innerHeight,ww2:a.innerWidth/2,wh2:a.innerHeight/2,cx:b.clientX,cy:b.clientY,ox:b.offsetX,oy:b.offsetY,t:c,tl:d.left,tt:d.top,cw:c.clientWidth,ch:c.clientHeight,cw2:c.clientWidth/2,ch2:c.clientHeight/2,left:e<a.innerWidth/2,top:f<a.innerHeight/2}},c=function(a){return a.offsetX||(a.offsetX=a.pageX-$(a.target).offset().left,a.offsetY=a.pageY-$(a.target).offset().top),a},d=function(a,b){new Opentip(this,$(a).find(".st-pop").html(),{tipJoint:(b.top?"top":"bottom")+" "+(b.left?"left":"right"),stem:!0})},e=function(a,b){console.log("qtipAdjust exposeButtons");var c=$(a).find(".btn-edit-sticker"),d=$(a).find(".btn-delete-sticker");$(a).on("mouseleave",function(){$(a).removeClass("st-show-buttons"),c.removeClass("btn-edit-bottom"),c.removeClass("btn-edit-top"),c.removeClass("btn-edit-right"),c.removeClass("btn-edit-left"),d.removeClass("btn-delete-bottom"),d.removeClass("btn-delete-top"),d.removeClass("btn-delete-right"),d.removeClass("btn-edit-left")}),$(".st-show-buttons").removeClass("st-show-buttons"),$(a).addClass("st-show-buttons"),b.top?(c.removeClass("btn-edit-bottom"),c.addClass("btn-edit-top"),d.removeClass("btn-delete-bottom"),d.addClass("btn-delete-top")):(c.removeClass("btn-edit-top"),c.addClass("btn-edit-bottom"),d.removeClass("btn-delete-top"),d.addClass("btn-delete-bottom")),b.left?(c.removeClass("btn-edit-right"),c.addClass("btn-edit-left"),d.removeClass("btn-delete-right"),d.addClass("btn-delete-left")):(c.removeClass("btn-edit-left"),c.addClass("btn-edit-right"),d.removeClass("btn-delete-left"),d.addClass("btn-delete-right"))};return function(a,f,g){f.on("mouseenter.open-tips click.open-tips",".st-grad",function(h){var i=g.firstRevenueOpenTip;if(a.layout.tooltips){console.log("first-revenue-open-tip linkElement=",f,"this=",this,"label=",i,"event=",h);var j=c(h),k=b(j),l=$.trim($(this).find(".st-pop").text());console.log("tooltips stickerText=["+l+"], quadrant=",k),l.length>0&&d(this,k,j),e(this,k),a.hovering=!0,a.$root.$apply()}})}}]),FirstRevenueApp.directive("firstRevenueTypeahead",["$timeout","$parse",function(a,b){var c="firstRevenueTypeahead",d=["search-query","input-mini","input-small","input-medium","input-large","input-xlarge","input-xxlarge"],e=function(a){for(var b in d){var c=d[b];a.hasClass(c)&&a.prev().addClass(c)}};return{restrict:"A",require:"ngModel",link:function(d,f,g){var h=b(g.ngModel),i=h(d);d.$watch(g.ngModel,function(a,b){a!==b&&(i=a),console.log(c,"$watch modelValue=",i)});var j=b(g.firstRevenueTypeahead)(d);console.log(c,"dataset=",j),j&&(f.typeahead(j),e(f)),d.$watch(g.firstRevenueTypeahead,function(a,d,h){j=b(g.firstRevenueTypeahead)(h),console.log(c,"$watch tah.dataset=",j),f.typeahead("destroy"),f.typeahead(j),e(f)},!0),f.on("typeahead:selected typeahead:autocompleted",function(b,e){console.log(c,"event $e=",b,"data=",e),a(function(){d.tah.selectedDatum=e,d.selectedUsers[e.service+"-"+e.serviceId]=e})})}}}]),FirstRevenueApp.directive("firstRevenueServiceIcon",["$timeout","$parse",function(a,b){return{restrict:"A",templateUrl:"views/ServiceIconSwitch.html",link:function(a,c,d){a.service=b(d.firstRevenueServiceIcon)(a),a.$watch(d.firstRevenueServiceIcon,function(a,c,e){e.service=b(d.firstRevenueServiceIcon)(e)},!0)}}}]),FirstRevenueApp.directive("gplusInvite",[function(){var a="gplusInvite";return{restrict:"EAC",replace:!0,templateUrl:"views/people/GPlusInviteButton.html",link:function(b,c){var d={contenturl:"http://prototype.1strevenue.com/1stRevenue/#/invite",contentdeeplinkid:"/1stRevenue/#/invite",clientid:"1010606663349.apps.googleusercontent.com",cookiepolicy:"http://1strevenue.com",prefilltext:"Join 1stRevenue.com and collaborate with us on business modeling. Use your Google+ account to sign to the application. The original sender of the invitation will be notified when you log on to the "+b.appName+". Create your account at the Join link below:",calltoactionlabel:"JOIN",calltoactionurl:"http://prototype.1strevenue.com/1stRevenue/#/invite",calltoactiondeeplinkid:"/1stRevenue/#/invite",recipients:b.key},e=c[0];gapi.interactivepost.render(e,d),console.log(a,"createButton partner=",b.partner,"options=",d,"element=",c,"button=",e)}}}]),FirstRevenueApp.directive("openTip",["$window","$timeout","Rainbow",function(a,b,c){var d=function(b){var c=$(b),d=c.offset(),e=d.left+b.context.clientWidth/2,f=d.top+b.context.clientHeight/2,g=e<a.innerWidth/2,h=f<a.innerHeight/2;return{top:h,left:g}},e=function(a){return(a.top?"top":"bottom")+" "+(a.left?"left":"right")},f=function(a,b,c){var f=d(a),g=[(f.left?-1:1)*$(a).width()/2,(f.top?-1:1)*$(a).height()/2],h={tipJoint:e(f),background:b,borderWidth:0,stem:!0,delay:"click"===c?0:1,offset:g,group:"1R",cache:!1,showOn:c,target:!0,hideTriggers:["closeButton","tip","target","trigger"]};return new Opentip(a,a.find(".st-pop").html(),h)},g=function(a,b){var c=$(a).find(".btn-edit-sticker"),d=$(a).find(".btn-delete-sticker");$(a).on("mouseleave",function(){$(a).removeClass("st-show-buttons"),c.removeClass("btn-edit-bottom"),c.removeClass("btn-edit-top"),c.removeClass("btn-edit-right"),c.removeClass("btn-edit-left"),d.removeClass("btn-delete-bottom"),d.removeClass("btn-delete-top"),d.removeClass("btn-delete-right"),d.removeClass("btn-edit-left")}),$(".st-show-buttons").removeClass("st-show-buttons"),$(a).addClass("st-show-buttons"),b.top?(c.removeClass("btn-edit-bottom"),c.addClass("btn-edit-top"),d.removeClass("btn-delete-bottom"),d.addClass("btn-delete-top")):(c.removeClass("btn-edit-top"),c.addClass("btn-edit-bottom"),d.removeClass("btn-delete-top"),d.addClass("btn-delete-bottom")),b.left?(c.removeClass("btn-edit-right"),c.addClass("btn-edit-left"),d.removeClass("btn-delete-right"),d.addClass("btn-delete-left")):(c.removeClass("btn-edit-left"),c.addClass("btn-edit-right"),d.removeClass("btn-delete-left"),d.addClass("btn-delete-right"))},h=function(a,b,e,h){b.on(e+".open-tips",function(){if(!a.draggingActive){var e=$(b).data();console.log("openTip linkElement.on","data=",e);var i=e.opentips,j=c.opaqueField(a.sticker.color),k=null;for(var l in i){var m=i[l];m.setContent(b.find(".st-pop").html()),m.options.background=j,m.redraw=!0,m.options.showOn===h&&(k=m)}k||(k=f(b,j,h),k.prepareToShow()),g(this,d(b))}})};return function(a,b){h(a,b,"mouseenter","mouseover"),h(a,b,"click","click")}}]),FirstRevenueApp.factory("BMG",[function(){var a="BMG";console.log(a,"service launched");var b={KP:{q:["Who are our Key Partners?","Who are our key suppliers?","Which Key Resources are we acquiring from partners?","Which Key Activities do partners perform?"],c:[{t:"Motivations for partnerships",l:["Optimization and economy","Reduction of risk and uncertainty","Acquisition of particular resources and activities"]}]},KA:{q:["What Key Activities do our Value Propositions require?","Our Distribution Channels?","Customer Relationships?","Revenue streams?"],c:[{t:"Categories",l:["Production","Problem solving","Platform/Network"]}]},KR:{q:["What Key Resources do our Value Propositions require?","Our Distribution Channels?","Customer Relationships?","Revenue Streams?"],c:[{t:"Types of Resources",l:["Physical","Intellectual (brand patents, copyrights, data)","Human","Financial"]}]},VP:{q:["What value do we deliver to the customer?","Which one of our customer's problems are we helping to solve?","What bundles of products and services are we offering to each Customer Segment?","Which customer needs are we satisfying?"],c:[{t:"Characteristics",l:["Newness","Performance","Customization",'"Getting the Job Done"',"Design","Brand/Status","Price","Cost Reduction","Accessibility","Convenience/Usability"]}]},CR:{q:["What type of relationship does each of our Customer Segments expect us to maintain with them?","Which ones have we established?","How are they integrated with the rest of our business model?","How costly are they?"],c:[{t:"Examples",l:["Personal assistance","Dedicated Personal Assistance","Self-Service","Automated Services","Communities","Co-creation"]}]},CH:{q:["Through which Channels do our Customer Segments want to be reached?","How are we reaching them now?","How are our Channels integrated?","Which ones work best?","Which ones are most cost-efficient?","How are we integrating then with customer routines?"],c:[{t:"Channel Phases",p:[{n:1,t:"Awareness",q:"How do we raise awareness about our company's products and services?"},{n:2,t:"Evaluation",q:"How do we help customers evaluate our organization's Value Proposition?"},{n:3,t:"Purchase",q:"How do we allow customers to purchase specific products and services?"},{n:4,t:"Delivery",q:"How do we deliver a Value Proposition to customers?"},{n:5,t:"After sales",q:"How do we provide post purchase customer support?"}]}]},CS:{q:["For whom are we creating value?","Who are our most important customers?"],c:[{t:"",l:["Mass Market","Niche Market","Segmented","Diversified","Multi-sided Platform"]}]},CX:{q:["What are the most important costs inherent in our business model?","Which Key Resources are most expensive?","Which Key Activities are most expensive?"],c:[{t:"Is your business more:",l:["Cost Driven (leanest cost structure, low price value proposition, maximum automation, extensive outsourcing)","Value Driven (focused on value creation, premium value proposition)"]},{t:"Sample Characteristics:",l:["Fixed Costs (salaries, rents, utilities)","Variable costs","Economies of scale","Economies of scope"]}]},RX:{q:["For what value are our customers really willing to pay?","For what do they currently pay?","How are they currently paying?","How would they prefer to pay?","How much does each Revenue Stream contribute to overall revenues?"],c:[{t:"Types:",l:["Asset sale","Usage fee","Subscription Fees","Lending/Renting/Leasing","Licensing","Brokerage fees","Advertising"]},{t:"Fixed Pricing",l:["List Price","Product feature dependent","Customer segment dependent","Volume dependent"]},{t:"Dynamic Pricing",l:["Negotiation (bargaining)","Yield management","Real-time Market"]}]}},c={getBlockPurpose:function(a){return b[a]}};return c}]),FirstRevenueApp.factory("Canvas",["_","Menu","BMG",function(a,b,c){var d="Canvas";console.log(d,"service launched");var e={bmg:c,view:"free",loaded:!1,modelId:0,lastModelId:0,model:null,singleBlock:null,showBlockInitials:!1,reset:function(){this.loaded=!1,this.model=null,this.singleBlock=null},setModel:function(a,c){e.modelId=a,e.model=c||null,b.selected="canvas",b.setTitle(c&&c.fields?c.fields.name:null)},setView:function(a){e.view=a},toggleView:function(){e.view="free"===e.view?"grid":"free"},peerCount:function(){return e.model?a.size(e.model.users):0},getStyle:function(){return"st-list-style4"},getLogoStyle:function(){var a=$(".model-logotype"),b=-Math.round(a.width()/2),c=-Math.round(a.height()/2);return{"margin-left":b,"margin-top":c}},getGridClass:function(){return"grid"===this.view?"pane-grid":"list"===this.view?"pane-list":""},getAbs:function(a){return"free"===e.view&&a&&angular.isNumber(a.x)&&angular.isNumber(a.y)||!1},getPosition:function(a){return e.getAbs(a)?"left: "+a.x+"%; top: "+a.y+"%;":""},switchBlock:function(b){console.log(d,"switchBlock pane=",b,"this.model.blocks=",e.model.blocks),e.singleBlock=a.find(e.model.blocks,function(a){return console.log(d,"switchBlock findingBlock b=",a),a.paneClass===b.icon})},getBackgroundImageURL:function(){return"images/DemoCanvasModelIcon.png"}};return e}]),FirstRevenueApp.factory("Favicon",[function(){var a={persona:"login.persona.org",gplus:"plus.google.com",gcontacts:"google.com"};return{getUrl:function(b){var c=a[b];return c=c||b+".com","//"+c+"/favicon.ico"}}}]),FirstRevenueApp.factory("FilePicker",["$timeout",function(a){var b="FilePicker",c={fpFile:null,attachIcon:function(a){c.fpicker(a)},replaceIcon:function(a){c.removeIcon(a),c.fpicker(a)},removeIcon:function(d){filepicker.setKey(CONFIG_1ST_REVENUE.filepickerKey),filepicker.remove(d.fields.icon,function(){console.log(b,"removeIcon icon removed"),a(function(){c.fpFile=null,d.fields.icon=null})},function(a){console.log(b,"removeIcon FPError=",a)})},fpicker:function(d){return filepicker.setKey(CONFIG_1ST_REVENUE.filepickerKey),filepicker.pickAndStore({maxSize:1048576},{location:"S3"},function(e){console.log(b,"filepicker",e),a(function(){c.fpFile=e,d.fields.icon=e[0].url})},function(a){console.log(b,"filepicker error",a.toString())}),!1}};return c}]),FirstRevenueApp.factory("Firebase",["$rootScope","$timeout","$location","$window","Myself","Layout","Notif",function(a,b,c,d,e,f,g){var h="Firebase";console.log(h,"service launched");var i={endpoint:CONFIG_1ST_REVENUE.firebaseEndpoint,nowRemote:null,rootRef:null,authClient:null,notif:g,providers:{facebook:{seq:1,icon:"facebook",title:"Facebook",method:"simple",scope:"email",border:"#3B5997"},linkedin:{seq:2,icon:"linkedin",title:"LinkedIn",method:"singly",option:"linkedin",border:"#0059A7"},gplus:{seq:7,icon:"google-plus",title:"Google+",method:"singly",option:"gplus",border:"#DD4B39"}},init:function(){i.rootRef=new Firebase(i.endpoint),Firebase.enableLogging(!0),console.log(h,"init fb.rootRef=",i.rootRef)},retrieveSession:function(){e.authFailed||(i.authClient=new FirebaseSimpleLogin(i.rootRef,i.verifySession))},resumeSession:function(){e.authFailed||(i.authClient=new FirebaseSimpleLogin(i.rootRef,i.generalAuth))},verifySession:function(a,b){console.log(h,"verifySession error=",a,"fbUser=",b);var d=!1;a?console.log(h,"verifySession Firebase returned an error=",a):b?(console.log(h,"verifySession Firebase auth success fbUser=",b,"sessionKey=",b.sessionKey),d=!0):console.log(h,"verifySession Firebase auth returned null fbUser=",b,"$location=",c),d&&e.mp.setLastUser(b),e.processInvite(d)},clearSession:function(){FirebaseSimpleLogin.prototype.clearSession()},setAdmin:function(a){e.adminRole=a},generalAuth:function(a,b){if(console.log(h,"generalAuth error=",a,"fbUser=",b),e.mp.clearLastUser(),a)console.log(h,"generalAuth Firebase returned an error=",a),i.authFailed(a);else if(b){if(console.log(h,"generalAuth Firebase auth success fbUser=",b,"sessionKey=",b.sessionKey),e.mp.setLastUser(b),b.sessionKey)FirebaseSimpleLogin.prototype.saveSession(b.firebaseAuthToken,b),delete b.sessionKey;else{var d=FirebaseSimpleLogin.prototype.readCookie("firebaseSessionKey");console.log(h,"sessionKey from cookie firebaseSessionKey=",d),b.firebaseSessionKey=d}var f=i.rootRef.child("usermap"),g=f.child(b.provider).child(b.id);g.once("value",function(a){console.log(h,"generalAuth","mapUserRef once value=",a.val()),i.checkUserMap(a.val(),b,g)})}else console.log(h,"generalAuth Firebase auth returned null fbUser=",b,"$location=",c),i.authFailed()},checkUserMap:function(a,b,c){if(a){var d=i.rootRef.child("users").child(a);d.once("value",function(d){var e=d.val();console.log(h,"checkUserMap","userRef once urValue=",e),e?(console.log(h,"checkUserMap","userRef urValue=",e),i.openSession(a,b)):(console.log(h,"checkUserMap","Remove orphan from user map: fbUser=",b),c.remove(function(){console.log(h,"checkUserMap","Orphan removed from user map: fbUser=",b),i.authFailed({code:"USER_UNKNOWN",message:b.service+" user "+(b.name?b.name:"")+" (id="+b.id+") not found in 1st Revenue",user:b})}))})}else console.log(h,"checkUserMap","No record in user map for fbUser=",b,"firebaseSessionKey=",b.firebaseSessionKey),i.clearSession(),console.log(h,"checkUserMap","Firebase session cleared"),b.service=b.service||b.provider,i.authFailed({code:"USER_UNKNOWN",message:i.providers[b.service].title+" user "+(b.name?b.name:"")+" (id="+b.id+") not found in 1st Revenue",user:b})},authFailed:function(a){console.log(h,"authFailed error=",a),e.authError(a),b(function(){"/entry"===c.$$url?f.setView("signin"):c.url("/entry")})},openSession:function(b,c,d){console.log(h,"openSession userId=",b,"fbUser=",c,"modelId=",d),e.wakeup(i.rootRef,b,d),console.log(h,"openSession resolving launch promise"),a.deferredLaunch.resolve(),analytics.identify(b,{id:c.id,provider:c.provider,name:c.name})},log:function(a){var b=new Date,c=b.getUTCFullYear(),d=b.getUTCMonth(),f=b.getUTCDate(),g=b.getUTCHours(),h=i.rootRef.child("log").child(c).child(d).child(f).child(g);a.time=b.getTime(),a.timeISO=b.toISOString(),a.user=e.sync.user.primary,h.push(a)},createModel:function(a,c){console.log(h,"createModel modelName=",a);var d=i.rootRef.child("models"),f=d.push(),g=f.name(),j={fields:{name:a},users:{},owner:e.userId};return j.users[e.userId]=!0,console.log(h,"createModel modelUpdate=",j),e.sync.models[g]={fields:{},users:{}},f.set(j,function(d,f){console.log(h,"createModel model created","modelUpdate=",j,"modelName=",a,"error=",d,"dummy=",f),i.log({op:d?"createModel-error":"createModel",error:d,path:"/models/"+g,model:j}),d||(e.sync.user.models=e.sync.user.models||{},e.sync.user.models[g]=!0,b(function(){c()}))}),g},getStickerPath:function(a){return"/models/"+a.modelId+"/stickers/"+a.id},getModelPath:function(a){return"/models/"+a.modelId},getRepoPath:function(a){return"/orgs/"+a.orgId+"/repos/"+a.repoId},getOrgPath:function(a){return"/orgs/"+a.id}};return i}]),FirstRevenueApp.factory("FullScreen",["$window","Notif",function(a,b){var c="FullScreen";return console.log(c,"service launched"),{fullScreenActive:!1,isFullScreen:function(){return a.navigator.standalone},toggle:function(){if(this.fullScreenActive=!this.fullScreenActive,this.fullScreenActive){var a=$(".first-revenue").get(0);a.requestFullScreen?a.requestFullScreen():a.mozRequestFullScreen?a.mozRequestFullScreen():a.webkitRequestFullScreen&&a.webkitRequestFullScreen(),b.add({text:"Full screen mode entered"})}else b.add({text:"Full screen mode closed"})}}}]),FirstRevenueApp.factory("Info",[function(){return{view:{model:!1,sticker:!1,user:!1,contact:!1,status:"",wide:!0,show:function(a){this.status=a},current:function(a){return this.status===a},toggle:function(){this.wide=!this.wide}},contactProvider:null,stickerModified:!1,reset:function(){this.view.model=this.view.sticker=this.view.user=this.view.contact=!1,this.stickerId=null},show:function(a){this.view[a]||this.toggle(a)},hide:function(a){this.view[a]&&this.toggle(a)},toggle:function(a){"model"===a||"sticker"===a?(this.view[a]=!this.view[a],this.view[a]&&(this.view.user=!1,this.view.contact=!1)):("user"===a||"contact"===a)&&(this.view[a]=!this.view[a],this.view.contact&&(this.view.user=!0),this.view.user?(this.view.model=!1,this.view.sticker=!1):this.view.contact=!1),this.view.sticker||$(".pulsate").removeClass("pulsate")},infoMode:function(){return this.view.model||this.view.sticker||this.view.user||this.view.contact},stickerButtonBlue:function(){return this.view.sticker&&!this.stickerModified},stickerButtonRed:function(){return this.view.sticker&&this.stickerModified},stickerIconWhite:function(){return this.view.sticker},stickerIconRed:function(){return!this.view.sticker&&this.stickerModified}}}]),FirstRevenueApp.factory("JWT",[function(){var a="JWT";return console.log(a,"service launched"),{decodeJWT:function(b){console.log(a,"decodeJWT token=",b);var c=b.split(".");if(3!==c.length)throw new Error("Not enough or too many segments");var d=c[0],e=c[1],f=c[2];console.log(a,"decodeJWT","headerSeg=",d,"payloadSeg=",e,"signatureSeg=",f);var g=this.base64urldecode(d),h=this.base64urldecode(e),i=this.base64urldecode(f);return console.log(a,"decodeJWT","header=",g,"payload=",h,"signature=",i),[JSON.parse(g),JSON.parse(h),i]},base64urldecode:function(a){var b=a;switch(b=b.replace(/-/g,"+"),b=b.replace(/_/g,"/"),b.length%4){case 0:break;case 2:b+="==";break;case 3:b+="=";break;default:throw new InputException("Illegal base64url string!")}return window.atob(b)},displayToken:function(b){var c=b.split(".");console.log(a,"displayToken tokenParts=",atob(c[0]),atob(c[1]),c[2])}}}]),FirstRevenueApp.factory("Layout",["$window","_","Popup","Zoom","FullScreen","Menu",function(a,b,c,d,e,f){var g="Layout";
console.log(g,"loaded");var h=["canvas","zoom","comment","stream","list"],i=["comment","stream","list"],j={title:"",colorValue:100,view:"",tooltips:!0,profile:!0,qrCode:!1,zoom:!1,comments:!1,stickerList:!1,guide:{wide:!0},peer:{wide:!0},editor:{model:!1,sticker:!1,contact:!1,user:!1},setView:function(a){this.view=a},isView:function(a){return this.view===a},showCanvas:function(){return b.contains(b.union(h,i),j.view)},showSideView:function(){return b.contains(i,j.view)},setGuideWidth:function(){j.guide.wide=Modernizr.mq("(min-width: 900px)")},reset:function(){c.reset(),d.reset(),j.view="",j.guide.wide=!0,j.peer.wide=!1},getLayoutClasses:function(){var a=[d.getZoomClass(j.zoom?null:0)];return j.editor.sticker&&a.push("edit-sticker"),a},isFullScreen:function(){return a.navigator.standalone},showButtons:function(){return"canvas"===f.selected},toggleZoom:function(){j.zoom=!j.zoom,j.zoom||d.reset()},toggleComments:function(){j.comments=!j.comments,j.stickerList=!1},toggleStickerList:function(){j.stickerList=!j.stickerList,j.comments=!1}};return j}]),FirstRevenueApp.factory("MasterScope",[function(){return{masterScope:null,setMasterScope:function(a){this.masterScope=a},getMasterScope:function(){return this.masterScope}}}]),FirstRevenueApp.factory("MemberCatalog",["_",function(a){return{sort:null,getMembers:function(){},getTitle:function(a){return a.title?a.title[0]:""},getFullTitle:function(b){return a.reduce(b.title||[],function(a,b){return(a?a+"\n":"")+b})},modelCount:function(b){return b.models?a.size(b.models):0},highlightModels:function(a){console.log("highlightModels member=",a,"event=",event),$(event.target).parent().children().css("color","darkred")}}}]),FirstRevenueApp.factory("Menu",["$window","AppName",function(a,b){var c=b,d={title:"1st Revenue",selected:"home",visible:["home","logon"],def:{home:{label:"Home",route:"home",icon:"home"},logon:{label:"Logon",route:"logon",icon:"user"},admin:{label:"Admin",route:"admin",icon:"wrench"},repo:{label:"Repo",route:"repo",icon:"list"},canvas:{label:"Canvas",route:"canvas",icon:"th-large"},create:{label:"Create",route:"canvas/new",icon:"edit"}},toggle:function(a){d[a]=!d[a]},setTitle:function(b){var e=b?b.indexOf(c)<0?b+" - "+c:b:c;d.title=a.document.title=e},getAppName:function(){return b}};return d}]),FirstRevenueApp.factory("Modal",[function(){var a={logon:!1,logoff:!1,dup:!1,dis:!1,del:!1,delNoRights:!1,model:!1,modelNew:!1,modelEditorTab:0,stickerId:null,sticker:null,contact:null,inviteText:null,inviteId:null,openDeleteStickerDialog:function(b,c){a.stickerId=b,a.sticker=c},isDeleteAllowed:function(){return!0}};return a}]),FirstRevenueApp.factory("ModelCatalog",["_","TagCatalog","Myself",function(a,b,c){var d="ModelCatalog";console.log(d,"service loaded");var e={sort:"time",tag:"*",ascending:!0,backInTime:!0,refreshModels:function(){},getModel:function(a){return c.sync.models[a]},isMine:function(a){return c.sync.models[a].owner===c.userId},isPublic:function(a){return c.sync.public.models&&!!c.sync.public.models[a]},isShared:function(a){return!!c.sync.user.models[a]&&!e.isMine(a)},isReadOnly:function(a){return e.isPublic(a)&&!c.sync.user.models[a]},getModelsNew3:function(a){var b={};return angular.forEach(c.sync.models,function(c,d){var f=e.isPublic(d);("all"===a||"public"===a&&f||"my"===a&&!f)&&(c.id=d,b[d]=c)}),this.sortModelList(b)},getModels:function(a){var b=[];return angular.forEach(c.sync.models,function(c,d){c.id=d;var f=e.isPublic(d),g=e.isMine(d),h=e.isShared(d);("all"===a||"public"===a&&f||"shared"===a&&h||"my"===a&&g)&&b.push(c)}),this.sortModelList(b)},getModelIdList:function(a){var b=[];return angular.forEach(c.sync.models,function(c,d){if(c&&c.fields){var f=e.isPublic(d),g=e.isMine(d),h=e.isShared(d);("all"===a||"public"===a&&f||"shared"===a&&h||"my"===a&&g)&&b.push(d)}}),this.sortModelIdList(b)},getFields:function(a){return c.sync.models[a].fields},getTags:function(a){return c.sync.models[a].tags},sortModelIdList:function(b){var d=b;return"name"===this.sort&&(d=a.sortBy(b,function(a){return c.sync.models[a].fields.name}),this.ascending||d.reverse()),"time"===this.sort&&(d=a.sortBy(b,function(a){return a}),this.backInTime&&d.reverse()),d},sortModelList:function(b){var c=b;return"name"===this.sort&&(c=a.sortBy(b,function(a){return a.fields.name}),this.ascending||c.reverse()),"time"===this.sort&&(c=a.sortBy(b,function(a){return a.id}),this.backInTime&&c.reverse()),c},nameSortOrder:function(){return this.ascending?"a-z":"z-a"},timeSortIconSuffix:function(){return(this.backInTime?"-back":"")+("time"===this.sort?"-white":"")},getMemberCount:function(b){var d=c.sync.models[b];return d.users?a.size(d.users):0},highlightMembers:function(a){console.log(d,"highlightMembers modelId=",a,"event=",event)},getAllTags:function(){var a=[];return angular.forEach(c.sync.models,function(b){console.log(d,"getAllTags model loop model.id=",b.id),angular.forEach(b.tags,function(b){console.log(d,"getAllTags tag loop tag.text=",b.text),a.push({text:b.text,type:"info",count:1})})}),console.log(d,"getAllTags allTags=",a),a},sortModels:function(a){"name"===this.sort?"name"===a?this.ascending=!this.ascending:(this.sort=a,this.ascending=!0):"time"===this.sort&&("time"===a?this.backInTime=!this.backInTime:(this.sort=a,this.backInTime=!0))},labelColor:function(a){return a===this.tag?"label-success":"label-info"},filterMatch:function(c){var d=e.getTags(c),f=b.tag,g=!1;if(f)if("*"===f)g=!0;else{var h=a.find(d,function(a){return a.text===f});g=!!h}else g=0===d.length;return g}};return e}]),FirstRevenueApp.factory("Model",[function(){return{modelId:null,model:null}}]),FirstRevenueApp.factory("Monitor",[function(){return{rateStats:null,globalStats:null,getRateStats:function(a){var b=this;now.getRateStats(function(c){console.log("Monitor.getRateStats=",c),b.rateStats=c,a()}),now.getGlobalStats(function(c){console.log("Monitor.getGlobalStats=",c),b.globalStats=c,a()})}}}]),FirstRevenueApp.factory("Notif",["_","Popup",function(a,b){var c="Notif";return console.log(c,"service launched"),{list:{},next:0,show:!1,add:function(a){console.log(c,"add",a),a.seq=this.next,a.time=new Date,a.type||(a.type="info"),this.list[this.next++]=a},remove:function(a){console.log(c,"remove index=",a,"item=",this.list[a]),delete this.list[a],console.log(c,"remove deleted notif=",this.list)},count:function(){return a.size(this.list)},get:function(a){return this.list[a]},getList:function(){return this.list},clear:function(){this.list={},this.next=0,b.notif=!1}}}]),FirstRevenueApp.value("Popup",{slider:!1,version:!1,zoom:!1,license:!1,member:!1,palette:!1,notif:!1,uservoice:!1,reset:function(){this.slider=this.version=this.zoom=this.license=this.member=this.palette=this.notif=!1},toggle:function(a){this[a]=!this[a]}}),FirstRevenueApp.factory("RGB",[function(){return{hsvObject:function(a,b,c){this.h=a,this.s=b,this.v=c,this.validate=function(){this.h<=0&&(this.h=0),this.s<=0&&(this.s=0),this.v<=0&&(this.v=0),this.h>360&&(this.h=360),this.s>100&&(this.s=100),this.v>100&&(this.v=100)}},rgbObject:function(a,b,c){this.r=a,this.g=b,this.b=c,this.validate=function(){this.r<=0&&(this.r=0),this.g<=0&&(this.g=0),this.b<=0&&(this.b=0),this.r>255&&(this.r=255),this.g>255&&(this.g=255),this.b>255&&(this.b=255)}},hexify:function(a){var b="0123456789ABCDEF",c=a%16,d=(a-c)/16,e=b.charAt(d)+b.charAt(c);return e},decimalize:function(a){var b="0123456789ABCDEF";return 16*b.indexOf(a.charAt(0).toUpperCase())+b.indexOf(a.charAt(1).toUpperCase())},hex2rgb:function(a,b){b.r=this.decimalize(a.substring(1,3)),b.g=this.decimalize(a.substring(3,5)),b.b=this.decimalize(a.substring(5,7))},rgb2hex:function(a){return"#"+this.hexify(a.r)+this.hexify(a.g)+this.hexify(a.b)},rgb2hsv:function(a,b){var c=a.r/255,d=a.g/255,e=a.b/255,f=Math.min(c,d,e),g=Math.max(c,d,e),h=g-f;if(b.v=g,0===h)b.h=0,b.s=0;else{b.s=h/g;var i=((g-c)/6+h/2)/h,j=((g-d)/6+h/2)/h,k=((g-e)/6+h/2)/h;c===g?b.h=k-j:d===g?b.h=1/3+i-k:e===g&&(b.h=2/3+j-i),b.h<0&&(b.h+=1),b.h>1&&(b.h-=1)}b.h*=360,b.s*=100,b.v*=100},hsv2rgb:function(a,b){var c=a.h/360,d=a.s/100,e=a.v/100;if(0===d)b.r=255*e,b.g=255*e,b.b=255*e;else{var f,g,h,i=6*c,j=Math.floor(i),k=e*(1-d),l=e*(1-d*(i-j)),m=e*(1-d*(1-(i-j)));0===j?(f=e,g=m,h=k):1===j?(f=l,g=e,h=k):2===j?(f=k,g=e,h=m):3===j?(f=k,g=l,h=e):4===j?(f=m,g=k,h=e):(f=e,g=k,h=l),b.r=255*f,b.g=255*g,b.b=255*h}}}}]),FirstRevenueApp.factory("Rainbow",["Canvas","RGB",function(a,b){var c="0123456789abcdef",d={red:{id:1,text:"Red",code:"F7D1D0"},yellow:{id:2,text:"Yellow",code:"F7F0C5"},gray:{id:3,text:"Gray",code:"EFEFEF"},blue:{id:4,text:"Blue",code:"D2E4EB"},magenta:{id:5,text:"Magenta",code:"E1D8ED"},salmon:{id:6,text:"Salmon",code:"FFD5C2"},cyan:{id:7,text:"Cyan",code:"D1F3EC"},neutral:{id:8,text:"Neutral",code:"FFFFFF"},green:{id:9,text:"Green",code:"DCEBD8"}};return{canvas:a,rgb:b,colorMap:d,getColorMap:function(){return this.colorMap},getColor:function(a){var b=this.colorMap[a];return b||this.colorMap.neutral},colorList:function(){return $.map(this.colorMap,function(a,b){return"neutral"===b?null:b})},colorCodeList:function(){return $.map(this.colorMap,function(a,b){return a.name=b,"neutral"===b?null:a})},brightenHex:function(a){return a=a||"FF0000",this.brightenFull(a)},brighten:function(a){var b=this.colorMap[a].code;return this.brightenFull(b)},brightenFull:function(a,b,c){var d=new this.rgb.rgbObject(0,0,0),e=new this.rgb.hsvObject(0,0,0);return this.rgb.hex2rgb("#"+a,d),this.rgb.rgb2hsv(d,e),0===e.s?e.v<100&&(e.v=c?c:80):(e.s=b?b:50,e.v=c?c:100),this.rgb.hsv2rgb(e,d),this.rgb.rgb2hex(d).substring(1)},opaqueField:function(a){var b=this.colorMap[a].code;return this.opaqueFieldHex(b)},brightenFieldCSS:function(a){return this.brightenFull(this.rgb2hex(a),100,100)},opaqueFieldCSS:function(a){var b=a.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/),c=new this.rgb.hsvObject(0,0,0),d=new this.rgb.rgbObject(b[1],b[2],b[3]);return this.makeOpaque(d,c)},opaqueFieldHex:function(a){var b=new this.rgb.rgbObject(0,0,0),c=new this.rgb.hsvObject(0,0,0);return a||(a="EFEFEF"),this.rgb.hex2rgb("#"+a,b),this.makeOpaque(b,c)},makeOpaque:function(a,b){return this.rgb.rgb2hsv(a,b),b.v<100?b.v=100:b.s=0===b.s?0:Math.max(0,b.s-10),this.rgb.hsv2rgb(b,a),this.rgb.rgb2hex(a).substring(1)},rgb2hex:function(a){return a=a.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/),this.hex(a[1])+this.hex(a[2])+this.hex(a[3])},hex:function(a){return isNaN(a)?"00":c[(a-a%16)/16]+c[a%16]}}}]),FirstRevenueApp.factory("RrrrRrrr",[function(){return{launching:!0,getImageLink:function(){var a=Math.floor(Math.random()*this.rrrrrrrrImages.length);return this.imageLinkPrefix+this.rrrrrrrrImages[a]+this.imageLinkSuffix},imageLinkPrefix:"http://24.media.tumblr.com/tumblr_m",imageLinkSuffix:"1rt0g8wo1_500.gif",rrrrrrrrImages:["euuwtJ9nV","dvka3G41p","dj1obEOlh","d65evMYkd","cnh5cn9C1","ccire33IK","bxp00m7C0","bpvhrbHPo","bd83rnrYp","b7s2s3EV3","b0f8a4pgB","ankvxXfq3","aami4M0HW","9x0hbDvcs","9rnf2HAO9","9k651ina7","9er5rZyEg","91f14NyEA","91etz18X0","8ogrxZX77","8ogo21KEv","8h55wLclu","8bjmzW8bc","84a7mPsXs","7yo1n6Rfq","7rcy6WHk8","7khbxGWM8","7egxdQaZ1","78mc8Yldh","71lryYOAM","6wfa4Cp85","6omiiIOmH","6j60b07bX","6bj3lYuJI","6682mxtuF","5ypkjdWsh","5sxx323Rm","5ldoe1E2b","5g2nqAeU8","58gra1RRz","52o9pcvrd","4w7mn4fxb","4qg8knCAj","4j0e4jRq4","47h6bViV8","47h3k3RZW","3xsjeuvbO","34rmyHRsK","3n2nqGWe7","3efuq0DT4","3efroqt6b","34rjhIzwL","33a7fTeZ3","2xt4ciY73","2s55mYp1q","2mos9dUK7","2gxxmlC3S","2b3fzb5HQ","27hm76FGR","244o3I4Fv","20202MWiD","1wjlbI0Zw","1uj03PKyA","1uht5a12i"]}}]),FirstRevenueApp.factory("TagCatalog",[function(){return{tag:"*",getTagCloud:function(){},tagFilter:function(a){this.tag=a},labelColor:function(a){var b=this.colorClass(a);return b?"label-"+b:""},colorClass:function(a){return a&&"*"!==a?a===this.tag?"success":"info":a===this.tag?"success":""},getModelCount:function(){},getTaggedCount:function(){return this.getModelCount()-this.getUntaggedCount()},getUntaggedCount:function(){var a=0;return a}}}]),FirstRevenueApp.factory("Zoom",["Popup","Canvas",function(a,b){var c="Zoom";console.log(c,"loaded");var d={0:{label:"full",title:"Full canvas"},1:{label:"customer",title:"Product market fit"},2:{label:"revenue",title:"Customer facing side"},3:{label:"cost",title:"Cost"},4:{label:"single",title:"Single block"},5:{label:"equal",title:"Equal area"},6:{label:"map",title:"Scrolling map"}},e={choice:0,singleBlock:!1,levels:d,canvas:b,getZoomClass:function(a){var b=angular.isNumber(a)?a:e.choice;return"canvas-"+d[b].label},reset:function(){e.choice=0,e.singleBlock=!1},zoom:function(b){console.log(c,"choice=",b),e.choice=b,a.zoom=!1}};return e}]),FirstRevenueApp.factory("Renderer",[function(){var a="Renderer",b=["1R Model","Competitors","CustSegm","Team","MarketTrends","MetaData","Incubators","SegmChan"],c={render:function(a,b){var d=arbor.ParticleSystem();d.parameters({stiffness:900,repulsion:2e3,gravity:!0,dt:.015}),d.renderer=c.create(a),d.graft(b)},create:function(c){var d=$(c),e=d.get(0),f=e.getContext("2d"),g=arbor.Graphics(e),h=null,i=null,j=null,k=null,l=null,m={init:function(b){console.log(a,"init pSystem=",b),h=b,h.screen({size:{width:d.width(),height:d.height()},padding:[36,60,36,60]}),$(window).resize(m.resize),m.resize(),m._initMouseHandling()},resize:function(){console.log(a,"resize"),e.width=$(window).width()-250,e.height=$(window).height()-150,console.log(a,"resize width=",e.width,"height=",e.height),h.screen({size:{width:e.width,height:e.height}}),i=null,m.redraw()},redraw:function(){g.clear(),h.eachEdge(function(a,b,c){a.source.data.alpha*a.target.data.alpha!==0&&g.line(b,c,{stroke:"#b2b19d",width:2,alpha:a.target.data.alpha})}),h.eachNode(function(a,b){var c=Math.max(20,20+g.textWidth(a.name));0!==a.data.alpha&&("dot"===a.data.shape&&(g.oval(b.x-c/2,b.y-c/2,c,c,{fill:a.data.color,alpha:a.data.alpha}),m._drawName(a,b,7),m._drawName(a,b,7)),"square"===a.data.shape?(g.rect(b.x-c/2,b.y-c/2,c,c,4,{fill:a.data.color,alpha:a.data.alpha}),m._drawName(a,b,9,"black"),m._drawName(a,b,9,"black")):(g.rect(b.x-c/2,b.y-8,c,20,4,{fill:a.data.color,alpha:a.data.alpha}),m._drawName(a,b,9),m._drawName(a,b,9)))}),m._drawVignette()},_drawName:function(a,b,c,d){g.text(a.name,b.x,b.y+c,{color:d?d:"white",align:"center",font:"Arial",size:12})},_drawVignette:function(){var a=e.width,b=e.height,c=20;if(!i){var d=f.createLinearGradient(0,0,0,c);d.addColorStop(0,"#e0e0e0"),d.addColorStop(.7,"rgba(255,255,255,0)");var g=f.createLinearGradient(0,b-c,0,b);g.addColorStop(0,"rgba(255,255,255,0)"),g.addColorStop(1,"white"),i={top:d,bot:g}}f.fillStyle=i.top,f.fillRect(0,0,a,c),f.fillStyle=i.bot,f.fillRect(0,b-c,a,c)},switchSection:function(a){var b=h.getEdgesFrom(a)[0].source,c=$.map(h.getEdgesFrom(a),function(a){return a.target});h.eachNode(function(a){var d=$.inArray(a,c)>=0,e=d?1:0;1===e&&(a.p.x=b.p.x+.05*Math.random()-.025,a.p.y=b.p.y+.05*Math.random()-.025,a.tempMass=.001)})},_initMouseHandling:function(){j=null,k=null;var a=null,c=null,f={moved:function(a){var f=$(e).offset();return l=arbor.Point(a.pageX-f.left,a.pageY-f.top),k=h.nearest(l),k&&k.node?("dot"!==k.node.data.shape?(j=k.distance<50?k:null,j?(d.addClass("linkable"),j.node.data&&j.node.data.link&&(window.status=j.node.data.link.replace(/^\//,"http://"+window.location.host+"/").replace(/^#/,""))):(d.removeClass("linkable"),window.status="")):$.inArray(k.node.name,b)>=0&&(k.node.name!==c&&(c=k.node.name,m.switchSection(c)),d.removeClass("linkable"),window.status=""),!1):!1},clicked:function(b){var c=$(e).offset();if(l=arbor.Point(b.pageX-c.left,b.pageY-c.top),k=a=h.nearest(l),k&&j&&k.node===j.node){var d=j.node.data.link;return d&&(d.match(/^#/)?$(m).trigger({type:"navigate",path:d.substr(1)}):window.location=d),!1}return a&&null!==a.node&&(a.node.fixed=!0),$(e).unbind("mousemove",f.moved),$(e).bind("mousemove",f.dragged),$(window).bind("mouseup",f.dropped),!1},dragged:function(b){var c=$(e).offset(),d=arbor.Point(b.pageX-c.left,b.pageY-c.top);if(k){if(null!==a&&null!==a.node){var f=h.fromScreen(d);a.node.p=f}return!1}},dropped:function(){return null!==a&&void 0!==a.node?(null!==a.node&&(a.node.fixed=!1),a.node.tempMass=1e3,a=null,$(e).unbind("mousemove",f.dragged),$(window).unbind("mouseup",f.dropped),$(e).bind("mousemove",f.moved),l=null,!1):void 0}};$(e).mousedown(f.clicked),$(e).mousemove(f.moved)}};return m}};return c}]),FirstRevenueApp.factory("StickerEditor",["$window","$log","_","Layout","Firebase","Rainbow","BMG",function(a,b,c,d,e,f,g){return{active:!1,block:null,stickerId:null,sticker:null,rainbow:f,firebase:e,bmg:g,purpose:"",showSticker:function(a,b,c){console.log("StickerEditor showSticker model=",a,"blockId=",b,"stickerId=",c);var e=this;this.active=!0,0===c?this.sticker={title:"",notes:"",block:b,color:"yellow"}:(this.stickerId=c,this.sticker=a.stickers[c]),d.editor.sticker=!0,this.purpose=this.bmg.getBlockPurpose(b),setTimeout(function(){e.focusTitle()},0)},setColor:function(a){this.sticker.color=a},checkModelRights:function(a){return console.log("StickerEditor checkModelRights rightName=",a),!0},matchTitle:function(){var a=this.sticker;return a&&a.shadow?a.shadow.title===a.title:!0},matchNotes:function(){var a=this.sticker;return a&&a.shadow?a.shadow.notes===a.notes:!0},matchColor:function(){var a=this.sticker;return a&&a.shadow&&a.color?a.shadow.color===a.color.name:!0},wasStickerModified:function(){return!(this.matchTitle()&&this.matchNotes()&&this.matchColor())},focusTitle:function(){var a=$(".field-title").get(0);a&&this.placeCaretAtEnd(a)},placeCaretAtEnd:function(b){if(b.focus(),"undefined"!=typeof a.getSelection&&"undefined"!=typeof a.document.createRange){var c=a.document.createRange();c.selectNodeContents(b),c.collapse(!1);var d=a.getSelection();d.removeAllRanges(),d.addRange(c)}else if("undefined"!=typeof a.document.body.createTextRange){var e=a.document.body.createTextRange();e.moveToElementText(b),e.collapse(!1),e.select()}}}}]),FirstRevenueApp.factory("ModelEditor",["_","Canvas",function(a,b){return{model:null,shadow:{name:null,icon:null,descr:null,pitch:null},wasModelModified:function(){return!0},matchModelDescr:function(c){var d=b.model.label;if(d){var e=a.find(c.fields,function(a){return"Notes"===a.label});if(e){var f=e.values[0].value;return f===c.notes}return""===c.notes}return!0}}}]),FirstRevenueApp.factory("Auth",["$rootScope","$location","$resource","$q","Firebase","Myself","Singly","Facebook",function(a,b,c,d,e,f,g,h){var i="Auth";return console.log(i,"service launched"),{deferred:null,rememberMe:!0,accepted:!1,launchLogon:function(a,b){switch(console.log("Auth.launchLogon method=",a,"provider=",b),f.error=null,a){case"simple":this.accepted=!0;var c={rememberMe:this.rememberMe};switch(b){case"password":c.email=f.email,c.password=f.password;break;case"facebook":c.scope="email";break;case"github":c.scope="user:email"}e.authClient.login(b,c);break;case"singly":this.accepted=!0,this.launchSinglyAuth(b);break;default:console.log("Auth.launchLogon unknown method=",a)}},launchLogonPopup:function(a,b){switch(console.log("Auth.launchLogonPopup method=",a,"provider=",b),f.error=null,a){case"simple":this.accepted=!0;var c={rememberMe:this.rememberMe};switch(b){case"password":c.email=f.email,c.password=f.password;break;case"facebook":c.scope="email",h.launchLogonPopup(function(a){console.log("Auth.launchLogonPopup Facebook response=",a),c.access_token=a.authResponse.accessToken,e.authClient.login(b,c)});break;case"github":c.scope="user:email"}e.authClient.login(b,c);break;case"singly":this.accepted=!0,this.launchSinglyAuth(b);break;default:console.log("Auth.launchLogonPopup unknown method=",a)}},signupPasswordAuth:function(){console.log("Auth.signupPasswordAuth email=",f.email,"password=",f.password),e.authClient.createUser(f.email,f.password,function(a,b){console.log("Auth.signupPasswordAuth email=",f.email,"password=",f.password),a?console.log("Auth.signupPasswordAuth error=",a):(console.log("Auth.signupPasswordAuth success user id=",b.id,"email",f.email),e.authClient.login("password",{email:f.email,password:f.password,rememberMe:!0}))})},launchPasswordAuth:function(){console.log("Auth.launchPasswordAuth email=",f.email,"password=",f.password),e.authClient.login("password",{email:f.email,password:f.password,rememberMe:!0})},launchFacebookAuth:function(){console.log("Auth.launchFacebookAuth"),e.authClient.login("facebook",{rememberMe:!0,scope:"email"})},launchTwitterAuth:function(){console.log("Auth.launchTwitterAuth"),e.authClient.login("twitter",{rememberMe:!0})},launchPersonaAuth:function(){console.log("Auth.launchPersonaAuth"),e.authClient.login("persona",{rememberMe:!0})},launchGithubAuth:function(){console.log("Auth.launchGithubAuth"),e.authClient.login("github",{rememberMe:!0,scope:"user:email"})},launchSinglyAuth:function(a,b){console.log("Auth.launchSinglyAuth service=",a),g.launchAuth(a,e.rootRef,b||e.generalAuth)},changePassword:function(){console.log("Auth.changePassword","email=",f.email,"oldPassword=",f.password,"newPassword=",f.newPassword),e.authClient.changePassword(f.email,f.password,f.newPassword,function(a,b){console.log("Auth.changePassword done error=",a,"success=",b),a?console.log("Auth.changePassword error=",a):console.log("Auth.changePassword success=",b)})}}}]),FirstRevenueApp.factory("Credentials",["$timeout","Firebase","Myself","$q",function(a,b,c,d){var e="Credentials";console.log(e,"Service launched");var f=c.mp,g={deferred:null,fb:b,fbAuthClient:null,fbUser:null,providers:b.providers,init:function(a){console.log(e,"init"),g.fbAuthClient=a},saveChanges:function(){console.log(e,"saveChanges","userId=",c.userId),g.mapRef=g.fb.rootRef.child("usermap"),g.accRef=g.fb.rootRef.child("users"),c.userId?(g.recRef=g.accRef.child(c.userId),console.log(e,"saveChanges uses existing user for recRef")):(g.recRef=g.accRef.push(),c.userId=g.recRef.name(),console.log(e,"saveChanges creates new user for recRef userId=",c.userId)),g.loadCred(f.firstCred).then(g.recurseCred)},loadCred:function(a){console.log(e,"loadCred","cred=",a);var b=d.defer();return a.detached?g.deleteCred(a,b):g.processCred(a,b),b.promise},recurseCred:function(a){console.log(e,"recurseCred","cred=",a),a?g.loadCred(a).then(g.recurseCred):g.doneCred()},deleteCred:function(a,b){console.log(e,"deleteCred","cred=",a);var d=a.profile;f.primaryToken===a.token&&(f.primaryToken=f.firstCred?f.firstCred.token:null),f.deleteAccount(d,a),console.log(e,"deleteCred","profile.provider=",d.provider,"profile.id=",d.id);var h=g.mapRef.child(d.provider).child(d.id);g.fb.rootRef.auth(a.token,function(d){d?g.mapSetAuthError(b,d):h&&(console.log(e,"deleteCred","setUserMap mapUserRef found, userId=",c.userId),g.removeUserMap(b,h,a))})},processCred:function(a,b){console.log(e,"processCred","cred=",a,"deferred=",b);var d=a.profile;f.primaryToken||(f.primaryToken=a.token),f.storeAccount(d,a),console.log(e,"processCred","profile.provider=",d.provider,"profile.id=",d.id);var h=g.mapRef.child(d.provider).child(d.id);g.fb.rootRef.auth(a.token,function(d){d?g.mapSetAuthError(b,d):h&&(console.log(e,"processCred","setUserMap mapUserRef found, userId=",c.userId),g.setUserMap(b,h,a))})},removeUserMap:function(b,c,d){c.remove(function(c){c?(console.log(e,"removeUserMap user map set error=",c),a(function(){b.reject(c)})):(console.log(e,"removeUserMap user map record removed, cred.next=",d.next),a(function(){b.resolve(d.next)}))})},setUserMap:function(b,d,f){d.set(c.userId,function(c){c?(console.log(e,"setUserMap user map set error=",c),a(function(){b.reject(c)})):(console.log(e,"setUserMap user map record created, cred.next=",f.next),a(function(){b.resolve(f.next)}))})},mapSetAuthError:function(b,c){"EXPIRED_TOKEN"===c.code?console.log(e,"mapSetAuthError error=",c,"Processing expired token"):(console.log(e,"mapSetAuthError","user map set auth failed error=",c),a(function(){b.reject(c)}))},doneCred:function(){console.log(e,"doneCred primaryToken=",f.primaryToken),f.primaryToken?g.fb.rootRef.auth(f.primaryToken,function(a){a?console.log(e,"doneCred","user account set auth failed error=",a):g.recRef.set(c.mp.user,g.doneCredSet)}):console.log(e,"doneCred","primaryToken not found")},doneCredSet:function(b){a(function(){if(b)console.log(e,"doneCred user account set error=",b);else{console.log(e,"doneCred user account record created");var a=c.mp.user.primary,d=c.mp.user.accounts[a].authentic;"singly"===d.provider?console.log(e,"doneCred provider singly authUser=",d):(console.log(e,"doneCred openSession authUser=",d),d.sessionKey=d.firebaseSessionKey,g.fbAuthClient.saveSession(f.primaryToken,d),c.authenticated=!0),g.fb.openSession(g.recRef.name(),d),c.mp.user=null}})}};return g}]),FirstRevenueApp.factory("Invite",["$timeout","$resource","$location","$q","_","Firebase","Auth","Myself",function(a,b,c,d,e,f,g,h){var i="Invite";console.log(i,"Service launched");var j=["facebook","twitter","github"],k=["linkedin","google","gplus","gmail","gcontacts"],l={deferred:null,fb:f,primaryToken:null,providers:{gplus:{seq:7,icon:"google-plus",title:"Google+",method:"singly",option:"gplus"},gcontacts:{seq:9,icon:"google-plus",title:"Google contacts",method:"singly",option:"gcontacts"},linkedin:{seq:2,icon:"linkedin",title:"LinkedIn",method:"singly",option:"linkedin"},facebook:{seq:1,icon:"facebook",title:"Facebook",method:"simple",scope:"email"}},userId:null,res:b,inviteId:null,inviteValue:null,inviteRef:null,setInvite:function(a,b){console.log(i,"setInvite id=",a),l.inviteId=a,b.then(function(b){console.log(i,"setInvite then id=",a,"v=",b),l.inviteValue=b})},ignoreInvite:function(){console.log(i,"ignoreInvite"),f.generalAuth(null,h.getLastUser())},abandonSession:function(){console.log(i,"abandonSession"),f.authClient.clearSession(),f.rootRef.unauth()},acceptInvite:function(a){console.log(i,"acceptInvite","service=",a),l.abandonSession(),l.authenticateInvite(a).then(l.inviteAuthenticated).then(l.inviteAuthorized).then(l.inviteExisting).then(l.userFetched).then(l.processInvite).then(l.doneInvite).then(l.createNewUser).then(l.updateInviteRecord).then(l.saveSession).then(l.inviteModels).then(l.attachModelsToUser).then(l.finishInvite,l.inviteFailed)},rejectResolve:function(b,c,d,e){if(b){var f=e||b;console.log(i,"rejectResolve","rejecting error=",f),c.reject(f)}else"function"==typeof d?(console.log(i,"rejectResolve","calling success"),d()):(console.log(i,"rejectResolve","resolving success=",d),a(function(){c.resolve(d)}))},authenticateInvite:function(a){var b=d.defer();if(e.contains(j,a)){var c=l.providers[a].scope,f={rememberMe:!0};c&&(f.scope=c),console.log(i,"authenticateInvite","Firebase service scope=",c,"options=",f),l.fb.authClient.launchAuthWindow(a,f,function(a,c,d){l.rejectResolve(a,b,function(){d.firebaseAuthToken=c,l.cbInvite(b,d)})})}else e.contains(k,a)&&(console.log(i,"authenticateInvite","Singly service"),console.log(i,"authenticateInvite","$timeout call Auth.launchSinglyAuth"),g.launchSinglyAuth(a,function(a,c){l.rejectResolve(a,b,function(){l.cbInvite(b,c)})}));return b.promise},cbInvite:function(b,c){console.log(i,"cbInvite","Invite=",l,"user=",c),c?(console.log(i,"cbInvite","resolving ivUser=",c),a(function(){b.resolve(c)})):(console.log(i,"cbInvite","null user"),h.authFailed=!0,b.reject("Authentication failed"))},inviteAuthenticated:function(a){var b=d.defer();h.authFailed=!0;var c=l.inviteValue.status;switch(c){case"created":b.reject("App error. This invite was not activated yet.");break;case"sent":l.inviteMatch(a)?h.authFailed=!1:b.reject("The invite was addressed to another user.");break;case"accepted":l.inviteMatch(a)?(console.log(i,"inviteAuthenticated","invite already accepted by yourself"),h.authFailed=!1):b.reject("The invite was already accepted, it was addressed to another user.");break;case"open":console.log(i,"inviteAuthenticated","accepting open invite","ivUser=".ivUser,"inviteValue=",l.inviteValue),h.authFailed=!1;break;default:b.reject("App error. Unknown invite status=",c)}return h.authFailed||(console.log(i,"inviteAuthenticated","sessionKey=",a.sessionKey),a.firebaseSessionKey=a.sessionKey||null,l.fb.rootRef.auth(a.firebaseAuthToken,function(c){l.rejectResolve(c,b,a)})),b.promise},inviteAuthorized:function(b){var c=d.defer();console.log(i,"inviteAuthorized","ivUser=",b);var e=l.fb.rootRef.child("usermap"),f=e.child(b.provider).child(b.id);return f.once("value",function(d){console.log(i,"inviteAuthorized","mapUserRef once value=",d.val()),b.mapValue=d.val(),a(function(){c.resolve(b)})}),c.promise},inviteMatch:function(a){var b=l.inviteValue;return"singly"===a.provider?a.service===b.service&&a.services[a.service].id===b.serviceId:a.provider===b.service&&a.id===b.serviceId},inviteExisting:function(b){var c=d.defer();if(console.log(i,"inviteExisting","mapValue=",b.mapValue,"ivUser=",b),b.mapValue){console.log(i,"inviteExisting","found usermap for user",b.provider+"/"+b.id,"value=",b.mapValue);var e=l.fb.rootRef.child("users").child(b.mapValue);e.once("value",function(d){var f=d.val();console.log(i,"inviteExisting","userRecordRef once value userRecord=",f),a(function(){b.record=f,l.recRef=e,l.userId=d.name(),l.fbUser=b,c.resolve(b)})},function(a){console.log(i,"inviteExisting","userRecordRef once value error=",a),c.reject(a)})}else c.resolve(b);return c.promise},userFetched:function(a){console.log(i,"userFetched","ivUser=",a);var b=d.defer();return a.record?"open"===l.inviteValue.status?l.connectUserToModels(b,a):l.updateInviteForExistingUser(b,a):l.createInvitedUser(b,a),b.promise},updateInviteForExistingUser:function(a,b){var c=b.record;l.inviteRef.update({status:"accepted",userId:l.userId,profile:c.profile},function(c){c?a.reject(c):l.connectUserToModels(a,b)})},connectUserToModels:function(a,b){l.fbUser=b,console.log(i,"userFetched","create promise chain shortcut to finish"),l.inviteModels().then(l.attachModelsToUser).then(l.finishInvite,l.inviteFailed),console.log(i,"userFetched","abandon the main promise chain"),a.reject({code:"EXISTING_USER_FOUND",message:"An existing user found"})},createInvitedUser:function(a,b){if(console.log(i,"createInvitedUser","ivUser=",b),b){var c=h.mp.storeInviteCredentials(b);l.mapRef=l.fb.rootRef.child("usermap"),l.accRef=l.fb.rootRef.child("users"),l.recRef=l.accRef.push(),l.userId=l.recRef.name(),l.fbUser=b,a.resolve(c)}else a.reject({code:"NO_USER",message:"No authenticated user passed to createInvitedUser"})},processInvite:function(a){var b=d.defer();console.log(i,"doneInvite cred=",a),l.primaryToken=a.token;var c=a.profile;h.mp.storeAccount(c,a);var e=l.mapRef.child(c.provider).child(c.id);return console.log(i,"processInvite","profile.provider=",c.provider,"profile.id=",c.id),l.fb.rootRef.auth(a.token,function(c){c?(console.log(i,"processInvite","user map set auth failed error=",c),b.reject(c)):e&&(console.log(i,"processInvite","setUserMap mapUserRef found, userId=",l.userId),e.set(l.userId,function(c){l.rejectResolve(c,b,a)}))}),b.promise},doneInvite:function(a){var b=d.defer();console.log(i,"doneInvite cred=",a),l.primaryToken=a.token;var c=a.profile;return h.mp.storeAccount(c,a),l.primaryToken&&l.fb.rootRef.auth(l.primaryToken,function(c){console.log(i,"createNewUser user account set error=",c,"cred=",a),l.rejectResolve(c,b,a)}),b.promise},createNewUser:function(a){var b=d.defer();return h.mp.user.inviteId=l.inviteId,l.recRef.set(h.mp.user,function(c){console.log(i,"createNewUser user account set error=",c,"cred=",a),l.rejectResolve(c,b,a)}),b.promise},updateInviteRecord:function(a){console.log(i,"updateInviteRecord cred=",a);var b=d.defer(),c={status:"accepted",userId:l.userId};return console.log(i,"updateInviteRecord inviteUpdate=",c,"cred=",a),l.inviteRef.update(c,function(c){console.log(i,"updateInviteRecord invite profile stored error=",c),l.rejectResolve(c,b,a)}),b.promise},saveSession:function(a){var b=d.defer();console.log(i,"saveSession cred=",a),console.log(i,"saveSession user account record created");var c=h.mp.user.primary,e=h.mp.user.accounts[c].authentic;return console.log(i,"saveSession openSession authUser=",e),l.fb.authClient.saveSession(l.primaryToken,e),h.authenticated=!0,l.inviteValue.models?console.log(i,"saveSession models=",l.inviteValue.models):console.log(i,"saveSession no models"),b.resolve(null),console.log(i,"saveSession returning promise=",b.promise),b.promise
},inviteModels:function(){console.log(i,"inviteModels userId=",l.userId);var a=e.keys(l.inviteValue.models||{});console.log(i,"inviteModels modelIds=",a);var b=[];return angular.forEach(a,function(a){console.log(i,"inviteModels modelId=",a);var c=l.fb.rootRef.child("models").child(a),e=d.defer();b.push(e.promise),console.log(i,"inviteModels setting userId=",l.userId),c.child("users").child(l.userId).set(l.inviteId,function(b){console.log(i,"inviteModels user userId=",l.userId,"added to model modelId=",a),l.rejectResolve(b,e,c.name())})}),d.all(b)},attachModelsToUser:function(a){var b=d.defer();console.log(i,"attachModelsToUser modelIds=",a);var c={};return angular.forEach(a,function(d){c[d]=!0,l.recRef.child("models").update(c,function(c){l.rejectResolve(c,b,a)})}),b.promise},finishInvite:function(a){console.log(i,"finishInvite modelIds=",a),l.completed=!0;var b=null;1===e.size(a)&&(b=a[0],l.modelId=b),c.path("/repo"),f.openSession(l.userId,l.fbUser)},inviteFailed:function(b){console.log(i,"inviteFailed error=",b),a(function(){l.error={message:b}})}};return l}]),FirstRevenueApp.factory("Register",["$timeout","$resource","$q","_","Firebase","Auth","Myself",function(a,b,c,d,e,f,g){var h="Register";console.log(h,"Service launched");var i=g.mp,j={deferred:null,fb:e,fbAuthClient:null,fbUser:null,providers:e.providers,res:b,init:function(){console.log(h,"init"),j.fb.clearSession(),j.fbAuthClient=new FirebaseSimpleLogin(j.fb.rootRef,j.cbVerify),i.services={},i.credentials={};var a=i.getLastUser();return a&&(console.log(h,"init attaching the last user firebaseSessionKey=",a.firebaseSessionKey),j.cbVerify(null,a)),j.fbAuthClient},unusedProviders:function(){return d.omit(j.providers,d.keys(i.services))},attach:function(a,b,c){g.error=null,console.log(h,"attach service=",a);var d=i.credentials[a];if(d&&d.detached)console.log(h,"attach - re-attach service=",a),d.detached=!1,i.services[a]=d.services[a];else if(i.isSameUser(a))console.log(h,"attach - same user found for service=",a),j.cbVerify(null,i.getLastUser());else{var e=j.fb.providers[a].method;switch(e){case"simple":j.attachSimple(a,b,c);break;case"singly":f.launchSinglyAuth(a,j.cbVerify);break;default:console.log(h,"Unsupported auth method=",e)}}},attachSimple:function(a,b,c){switch(a){case"persona":j.personaLogin();break;case"password":j.sendAuthRequest("/auth/firebase",{email:b,password:c});break;default:var d=j.providers[a].scope,e={rememberMe:!0};d&&(e.scope=d),j.fbAuthClient.launchAuthWindow(a,e,j.cbVerify3)}},detach:function(a){var b=i.credentials[a];console.log(h,"detach key=",a),b&&(b.detached=!0),delete i.services[a]},personaLogin:function(){var a=j.handlePersonaResponse;console.log(h,"personaLogin"),navigator.id.watch({onlogin:function(b){console.log(h,"personaLogin onlogin assertion=",b),a(b)},onlogout:function(){console.log(h,"personaLogin onlogout")}}),navigator.id.request({oncancel:function(){console.log(h,"personaLogin oncancel"),a(null)}})},handlePersonaResponse:function(a){console.log(h,"handlePersonaResponse authResponse=",a),null===a?j.cbVerify(j.fbAuthClient.formatError({code:"UNKNOWN_ERROR",message:"User denied authentication request or an error occurred."})):j.sendAuthRequest("/auth/persona/authenticate",{assertion:a})},sendAuthRequest:function(a,b){console.log(h,"sendAuthRequest url=",a,"json=",b),j.fbAuthClient.jsonp(a,b,function(a,b){console.log(h,"sendAuthRequest jsonp callback error=",a,"response=",b),a||!b.token?j.cbVerify(j.fbAuthClient.formatError(a)):(j.fbUser=b.user,j.fbUser.firebaseAuthToken=j.fbUser.firebaseAuthToken||b.token,j.cbVerify(null,j.fbUser))})},cbVerify3:function(a,b,c){c.firebaseAuthToken=b,j.cbVerify(a,c)},cbVerify:function(a,b){console.log(h,"cbVerify","Register=",j," error=",a,"user=",b),a?j.reportLaunchError(a):b&&(console.log(h,"cbVerify","sessionKey=",b.sessionKey),b.sessionKey?b.firebaseSessionKey=b.sessionKey||null:b.sessionKey=b.firebaseSessionKey||null,j.fb.rootRef.auth(b.firebaseAuthToken,function(a){if(a)j.reportLaunchError(a);else{console.log(h,"cbVerify","user.provider=",b.provider);var c=j.fb.rootRef.child("usermap"),d=c.child(b.provider).child(b.id);d.once("value",function(a){console.log(h,"cbVerify","mapUserRef once value=",a.val()),j.checkExisting(a,b)})}}))},checkExisting:function(a,b){var c=a.val();if(console.log(h,"checkExisting","mapUserId=",c,"fbUser=",b),c){console.log(h,"checkExisting","found usermap for user",b.provider+"/"+b.id,"mapUserId=",c);var d=j.fb.rootRef.child("users").child(c);d.once("value",function(d){var e=d.val();console.log(h,"checkExisting","userRecordRef once mapUserId userRecord=",e),e?(i.retrieveUserRecord(e,b.firebaseAuthToken),g.userId=c):(i.buildServiceCredentials(b),a.ref().remove(function(a){a?console.log(h,"checkExisting","Orphan user map entry for mapUserId=",c,"could not be deleted err=",a):console.log(h,"checkExisting","Orphan user map entry deleted for mapUserId=",c)}))},function(a){console.log(h,"checkExisting","userRecordRef once mapUserId error=",a),g.authFailed=!0})}else console.log(h,"checkExisting","mapUserId null - build credentials"),i.buildServiceCredentials(b)},reportLaunchError:function(a){console.log(h,"reportLaunchError","launchError=",a),g.authFailed=!0,g.error="unknown closed window"===a?{code:"WINDOW_CLOSED",message:"Authentication window has been closed"}:angular.isString(a)?{code:"UNKNOWN_ERROR",message:a}:a}};return j}]),FirstRevenueApp.factory("Singly",["$rootScope","$timeout","$resource","JWT",function(a,b,c,d){var e="Singly";console.log(e,"service launched");var f="menubar=0,location=0,resizable=0,scrollbars=0,status=0,dialog=1,width=700,height=375",g="https://api.singly.com/services/:service/:endpoint?limit=:limit&access_token=:token",h="https://api.singly.com/profile?access_token=:token",i={gmail:"contacts",gcontacts:"contacts",google:"self",gplus:"people",linkedin:"connections",facebook:"friends",twitter:"friends",github:"following",yammer:"users",meetup:"groups"},j={clientId:CONFIG_1ST_REVENUE.singlyClientId,accessToken:null,data:null,logoff:function(){j.accessToken=null},buildErrorAccount:function(a,b){var c=null,d=a.services[b];return d&&(c={name:a.name,service:b,id:d.id,image:a.thumbnail_url}),c},launchAuth:function(a,b,c){console.log(e,"launchAuth service=",a);var g=window.location.origin||window.location.protocol+"//"+window.location.host,h=g+window.location.pathname+"views/",k={client_id:j.clientId,redirect_uri:h+"SinglyRedirect.html",service:a,response_type:"token"};j.accessToken,"linkedin"===a?k.scope="r_basicprofile r_emailaddress r_network w_messages":"gplus"===a?k.scope="https://www.googleapis.com/auth/plus.login https://www.googleapis.com/auth/userinfo.email":"gcontacts"===a&&(k.scope="https://www.google.com/m8/feeds/"),console.log(e,"launchAuth Opening WinChan params=",k),WinChan.open({url:h+"SinglyLaunch.html",relay_url:h+"WinChanRelay.html",window_features:f,params:k},function(f,g){if(console.log(e,"launchAuth","error=",f,"response=",g),f)console.log(e,"launchAuth","error=",f),c(f);else{console.log(e,"launchAuth","response=",g),j.accessToken=g.access_token;var h=d.decodeJWT(g.firebase);console.log(e,"launchAuth","singlyFirebase=",h),j.getProfile(g.access_token,function(d){console.log(e,"launchAuth","Profile.get p=",d),b.auth(g.firebase,function(b,f){if(b){console.log(e,"Login Failed!",b);var h=j.buildErrorAccount(d,a);c({code:b.code,message:h.service+" user "+h.name+" (id="+h.id+") not found in 1st Revenue",user:h},f)}else console.log(e,"Login Succeeded! account=",f),j.processProfile(a,g,d,f,c)})}),j.getData(a,g.access_token,i[a],function(a){console.log(e,"launchAuth data=",a),angular.forEch(a,function(a){console.log(e,"launchAuth getData element=",a)})},function(a){console.log(e,"launchAuth getData error=",a)})}})},getProfile:function(b,d){console.log(e,"getProfile token=",b);var f=c(h,{token:b});console.log(e,"getProfile profileURL=",h),f.get(d,j.requestError),a.$$phase||a.$apply()},processProfile:function(a,b,c,d,f){var g=CryptoJS.MD5(b.firebase).toString(CryptoJS.enc.Hex),h={provider:"singly",token:b.access_token,firebaseAuthToken:b.firebase,sessionKey:g,id:d.auth.account,service:a,expires:d.expires,name:c.name||null,email:c.email||null,url:c.url||null,handle:c.handle||null,thumbnail_url:c.thumbnail_url||null,services:c.services||null};console.log(e,"processProfile acc=",h),f(null,h)},getData:function(b,d,f,h,i){console.log(e,"getData service=",b,"token=",d,"endpoint=",f);var k=h||j.processData,l=c(g,{service:b,token:d,endpoint:f,limit:20});j.data=l.query(k,i||j.requestError),a.$$phase||a.$apply()},processData:function(){angular.forEach(j.data,j.processElement)},processElement:function(a){console.log(e,"processElement element=",a)},requestError:function(a){console.log(e,"requestError error=",a)}};return j}]),FirstRevenueApp.factory("Myself",["$location","$timeout","$route","_","Sync","MyModels","MyProfile","Social",function(a,b,c,d,e,f,g,h){var i="Myself";console.log(i,"service launched");var j=f,k={rootRef:null,userRef:null,adminRef:null,publicRef:null,userId:null,provider:null,providerId:null,serviceId:null,authenticated:!1,authFailed:!1,error:null,adminRole:!1,email:null,password:null,newPassword:null,sync:e,mp:g,social:h,models:j.models,modelsLoaded:!1,currentModel:null,sessionFound:!1,originalPath:null,blocks:[{id:"KP",iconId:106,initials:"KP",name:"Key Partnerships"},{id:"KA",iconId:51,initials:"KA",name:"Key Activities"},{id:"KR",iconId:82,initials:"KR",name:"Key Resources"},{id:"VP",iconId:89,initials:"VP",name:"Value Propositions"},{id:"CR",iconId:83,initials:"CR",name:"Customer Relationships"},{id:"CH",iconId:261,initials:"CH",name:"Channels"},{id:"CS",iconId:175,initials:"CS",name:"Customer Segments"},{id:"CX",iconId:165,initials:"C$",name:"Cost Structure"},{id:"RX",iconId:200,initials:"R$",name:"Revenue Streams"}],init:function(a){console.log(i,"init"),k.originalPath=a},wakeup:function(a,b,c){console.log(i,"wakeup"),k.rootRef=a,k.userId=b,k.userRef=a.child("users").child(b),k.publicRef=a.child("public"),k.adminRef=a.child("admin").child(b),k.authenticated=!0,k.authFailed=!1,j.init(a,k.userRef),k.sync.angularFire(k.userRef,"sync.user").then(k.collectUserData),k.sync.angularFire(k.publicRef,"sync.public").then(k.collectPublicData),k.connTracking(a,b),k.selectedModelId=c||null,k.social.reset()},collectUserData:function(a){console.log(i,"wakeup userPromise resolved syncUserReady=",a),j.collectModels(k.userRef.child("models"),!1),a.value.admin===!0&&k.sync.angularFire(k.adminRef,"sync.admin.status").then(k.collectAdminData),k.navigateInitialView()},collectPublicData:function(a){console.log(i,"wakeup publicPromise resolved syncPublic=",a),j.collectModels(k.publicRef.child("models"),!0)},collectAdminData:function(a){console.log(i,"wakeup adminPromise resolved syncAdminReady=",a)},logoff:function(){console.log(i,"logoff"),j.logoff(),e.logoff(),k.userRef=null,k.userId=null},authError:function(a){console.log(i,"authError error=",a),k.authenticated=!1,k.authFailed=!0,a&&a.code&&(k.error=a)},processInvite:function(a){console.log(i,"processInvite"),k.sessionFound=a,b(function(){console.log(i,"processInvite $timeout calls $route.reload()"),c.reload()})},myDataValue:function(a){k.user=a.val(),console.log(i,"myDataValue me.user=",k.user),j.collectModels(k.userRef),j.collectModels(k.rootRef.child("public")),k.navigateInitialView()},navigateInitialView:function(){b(function(){k.modelsLoaded=!0,a.path(k.selectedModelId?"/canvas/"+k.selectedModelId:"/")})},dataCancel:function(c){console.log(i,"dataCancel error=",c),b(function(){a.path("/entry")})},isMyself:function(a){return a===k.userId},isOnline:function(a){return k.sync.peerPresence[a]<-1},connTracking:function(a,c){var d=a.child("presence").child(c),e=a.child(".info/connected");e.on("value",function(a){k.connected=a.val(),k.connected&&b(function(){d.onDisconnect().set(Firebase.ServerValue.TIMESTAMP),d.set(-Date.now())}),console.log(i,"connTracking connRef .info/connected connRef=",e,"me.connected=",k.connected,"me.connStatus=",k.connStatus())})},connStatus:function(){return k.connected?"Connected":"Offline"},modelCount:function(){return d.size(k.sync.user.models)},getAccounts:function(){return k.sync.user.accounts},getContacts:function(a){console.log(i,"getContacts accountId=",a);var b={};return a?k.getAccountContacts(b,k.sync.user.accounts[a]):angular.forEach(k.sync.user.accounts,function(a){k.getAccountContacts(b,a)}),b},getAccountContacts:function(a,b){if(b){var c=b.profile.service;angular.forEach(b.contacts.partners,function(b,d){a[c+"-"+d]=b})}},getSocialContacts:function(a){return console.log(i,"getContacts accountId=",a),k.getContacts(a)},toggleContact:function(a){var b=k.getContactKey(a);k.currentModel.users[b]?delete k.currentModel.users[b]:k.currentModel.users[b]=a},wasContactSelected:function(a){return console.log(i,"wasContactSelected contact=",a),k.currentModel?!!k.currentModel.users[k.getContactKey(a)]:{}},getContactKey:function(a){return a.service+"-"+a.id},inviteUsers:function(){},peerCount:function(){return d.size(k.getContacts())},findAccount:function(a){return d.find(k.sync.user.accounts,function(b){return b.profile.service===a})||{}}};return k}]),FirstRevenueApp.factory("MyProfile",["$timeout","_","TProfile",function(a,b,c){var d="MyProfile";console.log(d,"service loaded");var e={lastUser:null,user:null,credentials:{},primaryToken:null,services:{},firstCred:null,lastCred:null,getLastUser:function(){return e.lastUser},setLastUser:function(a){e.lastUser=a},clearLastUser:function(){e.lastUser=null},isSameUser:function(a){var b=e.lastUser?new c(e.lastUser):null;return b&&b.service===a},getService:function(){return"singly"===e.lastUser.provider?e.lastUser.service:e.lastUser.provider},getServiceId:function(){return"singly"===e.lastUser.provider?e.lastUser.services[e.lastUser.service].id:e.lastUser.id},wasCurrentUserInvited:function(a){return a.service===e.getService()&&a.serviceId===e.getServiceId()},buildServiceCredentials:function(b){if(b.provider){console.log(d,"buildServiceCredentials","user added to credentials");var f=new c(b);a(function(){e.storeCredential(f.service,{token:b.firebaseAuthToken,authentic:b,profile:f})})}},retrieveUserRecord:function(b,c){console.log(d,"retrieveUserRecord","ur=",b),a(function(){b.primary=b.profile.provider+"-"+b.profile.id,angular.forEach(b.accounts,function(a){e.storeCredential(a.profile.service,a)}),e.user=b,e.primaryToken=c})},storeInviteCredentials:function(a){console.log(d,"storeInviteCredentials","user added to credentials");var b=new c(a),f=b.service,g={token:a.firebaseAuthToken,authentic:a,profile:b},h={token:g.authentic.firebaseAuthToken,authentic:g.authentic,profile:g.profile,services:{},next:null,detached:!1};return"singly"===g.profile.provider?angular.forEach(g.authentic.services,function(a,b){var c={id:a.id,name:a.name},d=a.thumbnail_url;d&&(c.image=d),h.services[b]=c,e.services[b]=c}):(h.services[g.profile.provider]=g.profile,e.services[g.profile.provider]=g.profile),e.credentials[f]=h,e.enhanceProfile(g.profile),h},removeCred:function(a){console.log(d,"removeCred","cred=",a);for(var b=e.firstCred,c=null;b;){if(b===a){e.firstCred===a&&(e.firstCred=a.next),e.lastCred===a&&(e.lastCred=c),c&&(c.next=b.next);break}c=b,b=b.next}},storeCredential:function(a,b){console.log(d,"storeCredential","service=",a,"account=",b);var c=e.credentials[a];c&&e.removeCred(c);var f=b.authentic;c={token:f.firebaseAuthToken,authentic:f,profile:b.profile,services:{},next:null,detached:!1},console.log(d,"storeCredential","authentic=",f,"cred=",c),"singly"===b.profile.provider?angular.forEach(f.services,function(a,b){var f=e.getServiceObject(a);console.log(d,"storeCredential","singlyService=",a,"key=",b,"s=",f),c.services[b]=f,e.services[b]=f}):(console.log(d,"storeCredential","account.profile=",b.profile),c.services[b.profile.provider]=b.profile,e.services[b.profile.provider]=b.profile),e.credentials[a]=c,console.log(d,"storeCredential","mp.services=",e.services,"mp.credentials=",e.credentials),e.lastCred&&(e.lastCred.next=c),e.firstCred=e.firstCred||c,e.lastCred=c,e.enhanceProfile(b.profile)},getServiceObject:function(a){var b={id:a.id,name:a.name},c=a.thumbnail_url;return c&&(b.image=c),b},enhanceProfile:function(a){console.log(d,"enhanceProfile","serviceProfile=",a),e.user=e.user||{},e.user.profile=e.user.profile||{},b.defaults(e.user.profile,a),console.log(d,"enhanceProfile","mp.user=",e.user),e.user.primary=e.user.primary||a.key,e.user.profile.ready=!0},deleteAccount:function(a,c){var f=a.account?"singly-"+a.account:a.provider+"-"+a.id;if(e.user.primary===f){var g=b.keys(e.user.accounts);b.size(g)?(e.user.primary=g[0],e.user.profile=e.user.accounts[e.user.primary].profile):(delete e.user.primary,delete e.user.profile)}console.log(d,"deleteAccount","cred=",c,"profile=",a),e.user.accounts&&delete e.user.accounts[f],e.user.services&&angular.forEach(c.services,function(a,b){delete e.user.services[b]}),console.log(d,"deleteAccount","mp.user=",e.user)},storeAccount:function(a,b){var c=a.account?"singly-"+a.account:a.provider+"-"+a.id;e.user.primary||(e.user.primary=c,e.user.profile=a),console.log(d,"storeAccount","cred=",b,"profile=",a),e.user.accounts=e.user.accounts||{},e.user.accounts[c]=angular.copy({active:!0,profile:a,authentic:b.authentic,services:b.services?b.services:null}),e.user.services=e.user.services||{},angular.forEach(b.services,function(a,b){e.user.services[b]=angular.copy(a)}),e.user.models=e.user.models||{"*":"*"},console.log(d,"storeAccount","mp.user=",e.user)},getCredentials:function(){var a={};return angular.forEach(e.credentials,function(b,c){b.detached||(a[c]=b)}),a},getCredentialKeys:function(){return b.keys(e.getCredentials())}};return e}]),FirstRevenueApp.factory("MyModels",["$timeout","Sync","Canvas",function(a,b,c){var d="MyModels";console.log(d,"service launched");var e={rootRef:null,userRef:null,userId:null,sync:b,models:{},init:function(a,b){console.log(d,"init"),e.rootRef=a,e.userRef=b,e.userId=b.name()},logoff:function(){console.log(d,"logoff")},collectModels:function(a,b){a.on("child_added",function(a){e.loadModel(a.name(),b)},e.modelCancel),a.on("child_removed",e.modelRemoved,e.modelCancel)},modelRemoved:function(c){var f=c.name();console.log(d,"modelRemoved modelId=",f);var g=e.rootRef.child("models").child(f);g.child("users").off("child_added",e.processModelUsers),g.child("invites").off("child_added",e.processModelInvites),a(function(){b.reset(b.getScopeName(f,"models"))})},modelCancel:function(a){console.log(d,"modelCancel error=",a)},getModelKey:function(a){return b.getScopeName(a,"models")},loadModel:function(a,b){console.log(d,"loadModel modelId=",a,"publicFlag=",b);var c=e.rootRef.child("models").child(a),f=e.getModelKey(a);console.log(d,"loadModel modelKey=",f);var g=e.sync.angularFire(c,f);g?g.then(e.loadModelData):console.log(d,"loadModel angularFire failed for modelKey=",f)},loadModelData:function(a){console.log(d,"loadModelData modelPromise resolved modelReady=",a);var b=a.ref.name();if(a.value)if(a.value.users[e.userId]){console.log(d,"loadModelData user userId=",e.userId,"found for modelId=",b),c.modelId===b&&(c.model=e.sync.models[b]);var f=a.ref.child("users");f.on("child_added",e.processModelUsers);var g=a.ref.child("invites");g.on("child_added",e.processModelInvites)}else e.sync.user.models&&e.sync.user.models[b]&&(console.log(d,"loadModelData user not in model user list, deleting modelId=",b),delete e.sync.user.models[b]);else e.sync.user.models&&e.sync.user.models[b]&&(console.log(d,"loadModelData model does not exist, deleting modelId=",b),delete e.sync.user.models[b])},processModelUsers:function(a){var b=a.name();if(e.sync.peers[b])console.log(d,"processModelUsers peer already loaded key=",b);else{var c="sync.peers['"+b+"']",f=e.rootRef.child("users").child(b).child("profile"),g=e.sync.angularFire(f,c);g&&g.then(function(a){console.log(d,"processModelUsers resolved peer=",a)});var h="sync.peerPresence['"+b+"']",i=e.rootRef.child("presence").child(b),j=e.sync.angularFire(i,h,-1);j&&j.then(function(a){console.log(d,"processModelUsers resolved presence=",a)})}},processModelInvites:function(a){var b=a.name();if(e.sync.invites[b])console.log(d,"processModelInvites invite already loaded key=",b);else{var c="sync.invites['"+b+"']",f=e.rootRef.child("invites").child(b),g=e.sync.angularFire(f,c);g&&g.then(function(a){console.log(d,"processModelInvites resolved invite=",a),"accepted"===a.status&&console.log(d,"processModelInvites accepted invite=",a)})}}};return e}]),FirstRevenueApp.factory("Sync",["$q","angularFire",function(a,b){var c="Sync";console.log(c,"service loaded");var d={masterScope:null,user:{},models:{},invites:{},peers:{},peerPresence:{},admin:{status:!1,enabled:!1,presence:{},admins:{},users:{},models:{},invites:{},promises:[]},dereg:{},init:function(a){console.log(c,"init"),d.masterScope=a},angularFire:function(a,e,f){console.log(c,"angularFire name=",e,f),f=angular.isUndefined(f)?{}:f;var g=b(a,d.masterScope,e,f);return g.then(function(a){console.log(c,"angularFire callback afReady=",a),a.off&&a.name?d.dereg[e]=a.off:g.off&&(d.dereg[e]=g.off)}),g},reset:function(a){console.log(c,"reset name=",a);var b=d.dereg[a];b&&b()},getScopeName:function(a,b){return"sync."+b+"['"+a+"']"},collectAdminData:function(b){var c=[d.angularFire(b.child("presence"),"sync.admin.presence"),d.angularFire(b.child("admins"),"sync.admin.admins"),d.angularFire(b.child("users"),"sync.admin.users"),d.angularFire(b.child("models"),"sync.admin.models"),d.angularFire(b.child("invites"),"sync.admin.invites")];a.all(c).then(d.adminDataLoaded,d.adminDataFailed)},adminDataLoaded:function(a){console.log(c,"adminDataLoaded result=",a),d.admin.promises=a},adminDataFailed:function(a){console.log(c,"adminDataFailed err=",a)},logoff:function(){console.log(c,"logoff"),d.reset("sync.user"),d.reset("sync.public"),d.admin.status&&(d.reset("sync.admin.presence"),d.reset("sync.admin.admins"),d.reset("sync.admin.users"),d.reset("sync.admin.models"),d.reset("sync.admin.invites"),d.admin.status=!1,d.admin.enabled=!1,d.admin.presence={},d.admin.admins={},d.admin.users={},d.admin.models={},d.admin.invites={},d.admin.promises=[]),angular.forEach(d.models,function(a,b){d.reset(d.getScopeName(b,"models"))}),angular.forEach(d.invites,function(a,b){d.reset(d.getScopeName(b,"invites"))}),angular.forEach(d.peers,function(a,b){d.reset(d.getScopeName(b,"peers"))}),d.user={},d.models={},d.invites={},d.peers={},d.peerPresence={}}};return d}]),FirstRevenueApp.factory("TOrg",[function(){var a=function(a,b){this.id=a,b&&(this.name=b.name,this.descr=b.descr),this.repos={}};return a.prototype.xxxx=function(){},a}]),FirstRevenueApp.factory("TRepo",[function(){var a=function(a,b,c){this.orgId=a.id,this.id=b,c&&(this.name=c.name,this.descr=c.descr),this.models={}};return a.prototype.xxxx=function(){},a}]),FirstRevenueApp.factory("TModel",[function(){var a="TModel",b=[{id:"KP",iconId:106,initials:"KP",name:"Key Partnerships"},{id:"KA",iconId:51,initials:"KA",name:"Key Activities"},{id:"KR",iconId:82,initials:"KR",name:"Key Resources"},{id:"VP",iconId:89,initials:"VP",name:"Value Propositions"},{id:"CR",iconId:83,initials:"CR",name:"Customer Relationships"},{id:"CH",iconId:261,initials:"CH",name:"Channels"},{id:"CS",iconId:175,initials:"CS",name:"Customer Segments"},{id:"CX",iconId:165,initials:"C$",name:"Cost Structure"},{id:"RX",iconId:200,initials:"R$",name:"Revenue Streams"}],c=function(b,c,d){this.orgId=b.orgId,this.repoId=b.id,this.id=c,d&&(this.fields=angular.copy(d.fields)),this.createBlocks(),console.log(a,"constructor this=",this)};return c.prototype.createBlocks=function(){var c=this,d=c.id;c.blocks={};for(var e in b){var f=b[e];c.blocks[f.id]=c.blocks[f.id]||{paneClass:f.id,id:f.id,bmId:d,name:f.name,iconId:f.iconId,initials:f.initials,stickers:{}}}console.log(a,"createBlocks model=",c)},c}]),FirstRevenueApp.factory("TSticker",[function(){var a=function(a,b,c){console.log("scripts/services/obj/TSticker constructor this=",this,"model=",a,"id=",b,"sticker=",c),this.orgId=a.orgId,this.repoId=a.repoId,this.modelId=a.id,this.id=b,this.setFields(this,c)};return a.prototype.setFields=function(a,b){a.title=b.title,a.notes=b.notes,a.block=b.block,b.color=b.color||"yellow",a.color=b.color,b.x||b.y?a.position={absolute:!0,x:b.x,y:b.y}:a.position&&delete a.position,a.shadow={title:b.title,notes:b.notes,color:b.color}},a.prototype.update=function(a){console.log("scripts/services/obj/TSticker update this=",this,"sticker=",a),this.setFields(this,a)},a}]),FirstRevenueApp.factory("TProfile",[function(){var a=function(a){var b=angular.extend(this,{provider:a.provider||(a.account?"singly":null),service:a.service||a.provider,id:a.id||a.account,serviceId:a.services?a.services[a.service].id:a.id,email:a.email||null,name:a.name||(a.email?a.email.split("@")[0]:null),hash:a.hash||(a.email?CryptoJS.MD5(a.email).toString(CryptoJS.enc.Hex):null)});switch(b.key=b.provider+"-"+b.id,a.provider){case"facebook":b.link=a.link,b.image="//graph.facebook.com/"+a.id+"/picture";break;case"twitter":b.link="//twitter.com/"+a.username,b.image=a.profile_image_url;break;case"github":b.link=a.profileUrl,b.image=a.avatar_url;break;case"persona":b.image="//www.gravatar.com/avatar/"+b.hash;break;case"password":b.image="//www.gravatar.com/avatar/"+b.hash;break;case"singly":b.link=a.url,b.image=a.thumbnail_url;break;default:b.image=null}b.image=b.image||null,console.log("TProfile fbUser=",a,"profile=",b)};return a}]),FirstRevenueApp.factory("Social",["$timeout","_","Singly","Facebook","Twitter","LinkedIn","GPlus","GContacts","JWT",function(a,b,c,d,e,f,g,h,i){var j="Social";console.log(j,"service launched");var k={gmail:"contacts",gcontacts:"contacts",google:"self",gplus:"activities",linkedin:"connections",facebook:"friends",twitter:"friends",github:"following",yammer:"users",meetup:"groups"},l={partners:{},refreshed:0,total:0},m={me:null,account:null,selectedUsers:{},loaded:{},loading:{},contacts:{},linkedinMsg:{title:"",sender:{name:"",title:""},recipient:{name:""},date:"",text:"",link:""},reset:function(){m.selectedUsers={},m.loaded={},m.loading={},m.contacts={}},fetchAccount:function(a,b){m.me=a;var c=m.findAccount(b);m.fetchSocialAccount(c)},fetchSocialAccount:function(a){console.log(j,"fetchSocialAccount account=",a),a.contacts=a.contacts||l;var b=a.authentic.accessToken;if("singly"===a.profile.provider){var i=a.profile.service,n=a.authentic.token,o=k[i]||"self",p=a.authentic.expires,q=(new Date).getTime()/1e3;console.log(j,"fetchSocialAccount service=",i,"token=",n,"expires=",p,"currentTime=",q),"linkedin"===i?f.getFriends(m.me,a,n):"gplus"===i?c.launchAuth("gplus",m.me.rootRef,function(b,c){console.log(j,"fetchSocialAccount gplus err=",b,"acc=",c),c&&(m.me.sync.user.accounts["singly-"+c.id].authentic=c,g.getPeople(m.me,a,c.token))}):"gcontacts"===i?h.getContacts(m.me,a,n):o?c.getData(i,n,o):console.log(j,"Unknown Singly service, endpoint not found")}else"facebook"===a.profile.provider?d.getFriends(m.me,a,b):"twitter"===a.profile.provider&&e.getFriends(m.me,a,b)},addModelInvite:function(a,b){if(console.log(j,"addModelInvite data=",b),b){var c=angular.copy(b),d=m.me.rootRef.child("usermap").child(c.service).child(c.serviceId);d.once("value",function(b){var d=b.val();console.log(j,"addModelInvite usermap value userId=",d),d?m.attachModelToUser(a,c,d):m.verifyInviteMap(a,c),m.addPartner(c,d)})}},addPartner:function(a,c){var d=m.me.sync.user.partners=m.me.sync.user.partners||{},e=b.find(d,function(b){return b.service===a.service&&b.serviceId===a.serviceId});if(!e){var f=m.me.rootRef.push().name();e=d[f]={name:a.name,service:a.service,serviceId:a.serviceId,image:a.image},c&&(e.userId=c)}},attachModelToUser:function(a,b,c){console.log(j,"attachModelToUser userId=",c,"modelId=",a.modelId);var d=m.me.rootRef.child("users").child(c),e=d.child("models").child(a.modelId);e.set(!0,function(d){console.log(j,"attachModelToUser set completed err=",d),d||m.attachUserToModel(a,b,c)})},attachUserToModel:function(a,b,c){console.log(j,"attachUserToModel canvas=",a);var d=m.me.rootRef.child("models").child(a.modelId),e=d.child("users").child(c);e.set(!0,function(a){console.log(j,"attachUserToModel set completed err=",a)})},verifyInviteMap:function(a,b){console.log(j,"verifyInviteMap data=",b);var c=m.me.rootRef.child("invitemap").child(b.service).child(b.serviceId);c.once("value",function(d){var e=d.val();if(e){var f=m.me.rootRef.child("invites").child(e),g=f.child("models").child(a.modelId);g.set(!0,function(c){c?console.log(j,"failed to set model in invite inviteId=",e,"modelId=",a.modelId,"err=",c):console.log(j,"successfully set model in invite inviteId=",e,"modelId=",a.modelId,"err=",c),m.updateModelInvite(a,b,e)})}else m.createModelInvite(a,b,c,b.account)})},createModelInvite:function(a,b,c){console.log(j,"createModelInvite data=",b);var d={creator:m.me.userId,service:b.service,serviceId:b.serviceId,name:b.name,image:b.image||null,status:"created",models:{}};d.models[a.modelId]=!0;var e=m.me.rootRef.child("invites"),f=e.push().name();console.log(j,"createModelInvite inviteId=",f),e.child(f).set(d,function(e){e?console.log(j,"failed to create an invite=",d,"err=",e):c.set(f,function(){m.updateModelInvite(a,b,f)})})},updateModelInvite:function(b,c,d){console.log(j,"updateModelInvite data=",c),a(function(){var a=m.me.sync.models[b.modelId];a.invites=a.invites||{},a.invites[d]=!0,m.me.sync.user.invites=m.me.sync.user.invites||{},m.me.sync.user.invites[d]=!0})},updateInvite:function(a,c){console.log(j,"inviteId=",a);var d=m.me.rootRef.child("invites").child(a),e=m.findPartner(a);e.inviteId=a,c&&(e.inviteMsg=c),console.log(j,"updateInvite partner=",e),m.serviceInvite(e,function(a,c){console.log(j,"updateInvite sent partner=",e,"err=",a,"ack=",c),b.isEmpty(a)?(console.log(j,"invite sent partner=",e),d.update({status:"sent"},function(a){m.inviteCallback(a,e,"sent")})):console.log(j,"invite error=",a,"partner=",e)})},inviteCallback:function(a,b,c){a?(console.log(j,"invite global status cannot be set to",c,"error=",a),b.inviteFailed=!0):(console.log(j,"invite global status set to",c),"created"===c?b.inviteCreated=!0:"sent"===c&&(b.inviteSent=!0))},serviceInvite:function(a,b){var c=m.findAccount(a.service);switch(console.log(j,"serviceInvite contact=",a,"account=",c),a.service){case"facebook":d.sendMessage(a,b);break;case"linkedin":f.sendMessage(a,c.authentic.token,b);break;case"gplus":g.sendMessage(a,c.authentic.token,b);break;default:console.log(j,"invite does not have sendMessage function for service=",a.service)}},findAccount:function(a){return b.find(m.me.sync.user.accounts,function(b){return b.profile.service===a})},findPartner:function(a){var c=m.me.sync.invites[a];return b.find(m.me.sync.user.partners,function(a){return a.service===c.service&&a.serviceId===c.serviceId})},verifyExpiration:function(a,b){console.log(j,"verifyExpiration token=",a);var d=i.decodeJWT(a),e=d[1].exp;console.log(j,"verifyExpiration token=",a,"tokenArray=",d,"expires=",e),e<Math.floor(Date.now())?(console.log(j,"verifyExpiration token has expired"),c.launchAuth("gplus",m.me.rootRef,function(a,c){console.log(j,"verifyExpiration err=",a,"acc=",c),m.me.sync.user.accounts["singly-"+c.id].authentic=c,b(c.token)})):(console.log(j,"verifyExpiration token not expired"),b(a))},launchLinkedInModal:function(a,c){var d=window.location.origin||window.location.protocol+"//"+window.location.host,e=d+window.location.pathname+"#invite/"+a,f=b.find(m.me.sync.user.accounts,function(a){return"linkedin"===a.authentic.service}),g=f?f.authentic.services.linkedin:m.me.sync.user.profile,h={title:"Join 1stRevenue.com",sender:{name:g.name,title:g.description||"",image:g.thumbnail_url||null},recipient:{name:c.name},date:moment().format("LL"),link:e,text:"Hello "+c.name+". Join 1stRevenue.com and collaborate with us on business modeling. Use your LinkedIn account to sign to the application. "};m.linkedinMsg=h,m.inviteId=a,$("#modalLinkedIn").modal("show")}};return m}]),FirstRevenueApp.factory("Facebook",["$resource","$timeout",function(a,b){var c="Facebook",d="menubar=0,location=0,resizable=0,scrollbars=0,status=0,dialog=1,width=1000,height=600",e="https://graph.facebook.com/me/friends?fields=name,username,picture,email&access_token=:token",f={me:null,account:null,total:0,friends:null,launchLogonPopup:function(a){FB?(FB.getLoginStatus(function(b){"connected"===b.status?FB.ui({method:"oauth",display:"popup",scope:"",state:"123xyz:Facebook",response_type:"token"},function(b){b.session?(console.log(c,"launchLoginPopup - success - response=",b),a(b)):console.log(c,"launchLoginPopup - error - response=",b)
}):console.log(c,"launchLoginPopup - User is not logged in to Facebook response=",b)}),console.log(c,"launchLoginPopup - FB.getLoginStatus has been launched")):console.log(c,"launchLoginPopup - The Facebook SDK must be initialised before showing the friend selector")},sendMessage:function(a,b){console.log("Facebook sendMessage contact=",a);var d=window.location.origin||window.location.protocol+"//"+window.location.host,e=d+window.location.pathname+"views/",g=e+"FacebookInvitation.html",h=a.serviceId,i={name:"Invite to collaborate on model",app_id:CONFIG_1ST_REVENUE.facebookClientId,method:"send",to:h,link:g+"?invite="+a.inviteId};FB.getLoginStatus(function(a){"connected"===a.status?(console.log(c,"sendMessage fbParam=",i),FB.ui(i,f.processMessage(b))):FB.login(function(a){a.authResponse?(console.log(c,"sendMessage response=",a),FB.ui(i,f.processMessage(b))):(console.log(c,"User cancelled login or did not fully authorize."),FB.ui(i,f.processMessageError(b)))})})},processMessage:function(a){return function(b){console.log(c,"processMessage msgResponse=",b),a(null,b)}},processMessageError:function(a){return function(b){console.log(c,"processMessageError error=",b),a(b)}},sendMessagePage:function(a,e){console.log("Facebook sendMessage contact=",a);var f=window.location.origin||window.location.protocol+"//"+window.location.host,g=f+window.location.pathname+"views/",h=g+"FacebookRedirect.html",i=g+"FacebookInvitation.html",j=a.serviceId,k={app_id:CONFIG_1ST_REVENUE.facebookClientId,redirect_uri:h,display:"page",to:j,link:i+"?invite="+a.inviteId};WinChan.open({url:g+"FacebookLaunch.html",relay_url:g+"WinChanRelay.html",window_features:d,params:k},function(a,d){b(function(){console.log(c,"sendMessage","error=",a,"response=",d),a?(console.log(c,"sendMessage","error=",a),e(a)):(console.log(c,"sendMessage","response=",d),d.success?e(null,!0):e(null,!1))})})},getFriendsNew:function(b,d,g){f.me=b,f.account=d,f.me.social.loaded.facebook=!1,console.log(c,"getFriends token=",g);var h=a(e,{token:g});f.friends=h.get(f.processFriends,f.queryError),FB?FB.getLoginStatus(function(a){"connected"===a.status?FB.api("/me/friends?fields=id,name,username,picture,email",function(a){a.data?f.processFriends(a):console.log(c,"getFriends - No friends returned")}):console.log(c,"getFriends - User is not logged in to Facebook response=",a)}):console.log("The Facebook SDK must be initialised before showing the friend selector")},getFriends:function(b,d,g){f.me=b,f.account=d,f.me.social.loaded.facebook=!1,console.log(c,"getFriends token=",g);var h=a(e,{token:g});f.friends=h.get(f.processFriends,f.queryError)},processFriends:function(a){console.log(c,"processFriends friends=",a),f.me.social.contacts.facebook=f.me.social.contacts.facebook||{},b(function(){f.total=0,f.account.contacts=f.account.contacts||{refreshed:Date.now()},angular.forEach(a.data,f.processFriend),console.log("Facebook processFriends facebook.total=",f.total);var b=f.account.profile.key,c=f.me.sync.user.accounts[b],d=c.contacts;d.refreshed=Date.now(),d.total=f.total,f.me.social.loaded.facebook=!0,console.log("Facebook processFriends contacts=",f.account.contacts,"facebook.me.social.loaded.facebook=",f.me.social.loaded.facebook,"facebook.me.sync=",f.me.sync),a.paging.next})},processFriend:function(a){console.log("Facebook processFriend friend=",a),console.log("Facebook processFriend profile.key=",f.account.profile.key,"account=",f.account);var b=f.account.contacts.partners,c=f.me.social.contacts.facebook[a.id]={profileKey:f.account.profile.key,provider:"facebook",service:"facebook",id:a.id,serviceId:a.id,name:a.name,username:a.username,image:a.picture.data.url||null};b&&b[a.id]&&(b[a.id].name=c.name,b[a.id].image=c.image,c.partner=b[a.id]),console.log("Facebook processFriend c=",c),f.total+=1},queryError:function(a){console.log("Facebook queryError error=",a)}};return f}]),FirstRevenueApp.factory("GContacts",["$resource","$timeout",function(a,b){var c="https://api.singly.com/proxy/gcontacts/contacts/default/full?access_token=:token&max-results=1000&alt=json",d="https://api.singly.com/proxy/gcontacts/groups/default/base?access_token=:token&max-results=1000&alt=json",e="http://schemas.google.com/contacts/2008/rel#edit-photo",f={me:null,account:null,contacts:null,groups:null,token:null,total:0,getContacts:function(b,e,g,h){f.me=b,f.account=e,f.token=g,console.log("GContacts getContacts token=",g);var i=a(c,{token:g}),j=h||f.processContacts;f.contacts=i.get(j,f.requestError);var k=a(d,{token:g});f.groups=k.get(f.processGroups,f.requestError)},processContacts:function(a){console.log("GContacts processContacts contacts=",a),f.account.friends=a,b(function(){f.total=0,angular.forEach(a.feed.entry,f.processContact),f.account.contacts.refreshed=Date.now(),f.me.social.loaded.linkedin=!0})},processContact:function(a){console.log("GContacts processContact contact=",a);var b=a.gd$email,c=a.id.$t.split("/")[8];if(c){var d=f.account.contacts.partners,g=f.me.social.contacts.linkedin[a.id]={profileKey:f.account.profile.key,service:"gcontacts",id:c,serviceId:c,name:a.title.$t,email:"",org:"",image:"",phone:""};d&&d[a.id]&&(g.partner=d[a.id]),f.total+=1,b&&(g.email=b[0].address,angular.forEach(b,function(a){"true"===a.primary&&(g.email=a.address)})),a.gd$organization&&(g.org=a.gd$organization[0].gd$orgName.$t),a.link[0].gd$etag&&angular.forEach(a.link,function(a){a.gd$etag&&"image/*"===a.type&&a.rel===e&&(g.image=a.href)}),a.gd$phoneNumber&&angular.forEach(a.gd$phoneNumber,function(a){"true"===a.primary&&(g.phone=a.$t)}),console.log("GContacts processContact c=",g)}},processGroups:function(a){console.log("GContacts processGroups groups=",a)},requestError:function(a){console.log("GContacts requestError error=",a)}};return f}]),FirstRevenueApp.factory("GPlus",["$resource","$http","$timeout",function(a,b,c){var d="GPlus",e="https://api.singly.com/profiles/gplus?auth=true&access_token=:token",f="https://www.googleapis.com/plus/v1/people/me",g="https://www.googleapis.com/plus/v1/people/me/people/visible",h={me:null,account:null,total:0,people:null,token:null,getPeople:function(b,c,f){if(console.log(d,"getPeople account=",c,"token=",f),h.me=b,h.account=c,h.token=f,h.me.social.loaded.gplus=!1,!b.social.loading.gplus){console.log(d,"getPeople launching profileRequest"),b.social.loading.gplus=!0;var g=a(e,{token:f});h.profile=g.get(h.processProfile,h.requestError)}},processProfile:function(a){c(function(){console.log(d,"processProfile profile=",a),b({method:"GET",url:f,params:{key:CONFIG_1ST_REVENUE.gplusAPIKey},headers:{Authorization:"Bearer "+a.auth.accessToken}}).success(h.processGPlusProfile).error(h.requestError),h.total=0,h.account.contacts=h.account.contacts||{refreshed:Date.now()},h.bearerToken=a.auth.accessToken,h.sendPeopleRequest()})},sendPeopleRequest:function(a){console.log("GPlus sendPeopleRequest pageToken=",a),b({method:"GET",url:g,params:{key:CONFIG_1ST_REVENUE.gplusAPIKey,pageToken:a||null},headers:{Authorization:"Bearer "+h.bearerToken}}).success(h.processGPlusPeople).error(h.requestError)},processGPlusProfile:function(a){c(function(){console.log("GPlus processGPlusProfile gprofile=",a)})},processGPlusPeople:function(a){console.log("GPlus processGPlusPeople people=",a),h.me.social.contacts.gplus=h.me.social.contacts.gplus||{},c(function(){if(angular.forEach(a.items,h.processPerson),console.log("GPlus processGPlusPeople people.nextPageToken=",a.nextPageToken),a.nextPageToken)h.sendPeopleRequest(a.nextPageToken);else{var b=h.account.profile.key,c=h.me.sync.user.accounts[b];console.log("GPlus processGPlusPeople gplus=",h,"acc=",c);var d=c.contacts;d.refreshed=Date.now(),d.total=h.total,h.me.social.loaded.gplus=!0,h.me.social.loading.gplus=!1,console.log("GPlus processGPlusPeople key=",b,"social=",h.me.social,"contacts=",d)}})},processPerson:function(a){console.log("GPlus processPerson person=",a);var b=h.account.contacts.partners,c=h.me.social.contacts.gplus[a.id]={profileKey:h.account.profile.key,provider:"singly",service:"gplus",type:a.objectType,name:a.displayName,image:a.image.url,id:a.id,serviceId:a.id};b&&b[a.id]&&(c.partner=b[a.id]),h.total+=1},requestError:function(a){c(function(){console.log("GPlus requestError error=",a)})}};return h}]),FirstRevenueApp.factory("LinkedIn",["$resource","$timeout",function(a,b){var c="LinkedIn";console.log(c,"service launched");var d="https://api.singly.com/proxy/linkedin/people/~/connections?callback=JSON_CALLBACK&format=json&access_token=:token&scope=r_network",e="https://api.singly.com/proxy/linkedin/people/~/mailbox?format=json&access_token=:token&scope=w_messages",f={me:null,account:null,total:0,friends:null,token:null,msg:null,sendMessageREST:function(b,d,g){f.token=d,console.log(c,"sendMessage token=",d);var h=a(e,{token:d}),i=$("<div>"+b.inviteMsg.text+"</div>").text(),j=new h({recipients:{values:[{person:{_path:"/people/"+b.serviceId}}]},subject:"Join 1stRevenue.com",body:i+" Visit "+b.inviteMsg.link}),k=g||f.processMessage;j.$save(function(a){console.log(c,"processMessage msgResponse=",a),k(null,!0)},f.requestError)},sendMessage:function(a,b,d){f.token=b,console.log(c,"sendMessage token=",b),window.CONFIG_1ST_REVENUE.linkedinLoaded&&(IN.User.isAuthorized()?f.sendMessageCallback(a,d)():IN.User.authorize(f.sendMessageCallback(a,d)))},sendMessageCallback:function(a,b){return function(){console.log(c,"sendMessageCallback contact=",a);var d=$("<div>"+a.inviteMsg.text+"</div>").text(),e={recipients:{values:[{person:{_path:"/people/"+a.serviceId}}]},subject:"Join 1stRevenue.com",body:d+" Visit "+a.inviteMsg.link};IN.API.Raw("/people/~/mailbox").method("POST").body(JSON.stringify(e)).result(f.processMessage(b)).error(f.processMessageError(b))}},processMessage:function(a){return function(b){console.log(c,"processMessage msgResponse=",b),a(null,b)}},processMessageError:function(a){return function(b){console.log(c,"processMessageError error=",b),a(b)}},getFriendsREST:function(b,e,g,h){f.me=b,f.account=e,f.token=g,f.me.social.loaded.linkedin=!1,console.log(c,"getFriends token=",g);var i=a(d,{alt:"json"},{get:{method:"JSONP",params:{token:g},transformResponse:function(a,b){console.log(c,"transformResponse data=",a,b)}}}),j=h||f.processFriends;f.friends=i.get(j,f.requestError)},getFriends:function(a,b,c,d){f.me=a,f.account=b,f.token=c;var e=d||f.processFriends;window.CONFIG_1ST_REVENUE.linkedinLoaded&&(IN.User.isAuthorized()?f.getFriendsCallback(e)():IN.User.authorize(f.getFriendsCallback(e)))},getFriendsCallback:function(a){return function(){console.log(c,"getFriendsCallback"),IN.API.Connections("me").result(a)}},processFriends:function(a){console.log(c,"processFriends friends=",a),f.me.social.contacts.linkedin=f.me.social.contacts.linkedin||{},b(function(){f.total=0;var b=f.account.contacts=f.account.contacts||{refreshed:Date.now()};angular.forEach(a.values,f.processFriend),b.refreshed=Date.now(),b.total=f.total,f.me.social.loaded.linkedin=!0,console.log(c,"processFriends contacts=",b,"linkedin.me.social.loaded.linkedin=",f.me.social.loaded.linkedin,"linkedin.me.sync=",f.me.sync)})},processFriend:function(a){if(console.log(c,"processFriend friend=",a),"private"!==a.id){var b=f.account.contacts.partners,d=f.me.social.contacts.linkedin[a.id]={profileKey:f.account.profile.key,provider:"singly",service:"linkedin",id:f.account.profile.id,serviceId:a.id,name:a.firstName+" "+a.lastName,username:null,image:a.pictureUrl||null};b&&b[a.id]&&(d.partner=b[a.id]),console.log(c,"processFriend c=",d),f.total+=1}},processProfile:function(a){console.log(c,"processProfile profile=",a)},requestError:function(a){console.log(c,"requestError error=",a)}};return f}]),FirstRevenueApp.factory("Twitter",["$resource","$timeout",function(a,b){var c="https://api.twitter.com/1.1/friends/list.json",d={friends:null,getFriends:function(b){console.log("Twitter getFriends token=",b);var e=a(c,{token:b});d.friends=e.get(d.processFriends,d.queryError)},processFriends:function(a){console.log("Twitter processFriends friends=",a),b(function(){angular.forEach(d.friends.data,d.processFriend)})},processFriend:function(a){console.log("Twitter processFriend friend=",a)},queryError:function(a){console.log("Twitter queryError error=",a)}};return d}]),FirstRevenueApp.factory("ImpressModel",["$timeout","$window","Canvas","angularFire",function(a,b,c,d){var e="ImpressModel";console.log(e,"service launched");var f={rootRef:null,masterScope:null,dereg:{},init:function(a,b){console.log(e,"init"),f.rootRef=a,f.masterScope=b},angularFire:function(a,b,c){console.log(e,"angularFire name=",b,c),c=angular.isUndefined(c)?{}:c;var g=d(a,f.masterScope,b,c);return g.then(function(a){console.log(e,"angularFire callback afReady=",a),a.off&&a.name?f.dereg=a.off:g.off&&(f.dereg=g.off)}),g},loadModel:function(a){console.log(e,"loadModel modelId=",a);var b=f.rootRef.child("models").child(a),c=f.angularFire(b,"canvas.model");c?c.then(f.loadModelData):console.log(e,"loadModel angularFire failed for modelId",a)},loadModelData:function(d){console.log(e,"loadModelData modelPromise resolved modelReady=",d),a(function(){b.document.title=c.model.fields.name+" - 1st Revenue Presentation",impress().init()})}};return f}]);